---
alwaysApply: false
---
###  BLOQUE 1: Contexto del Proyecto y Reglas del Juego

```markdown
Act煤a como **Ingeniero de Sistemas Principal** experto en emulaci贸n de Game Boy, C++17 y arquitectura de software h铆brida. Retomamos el desarrollo de **Viboy Color** (v0.0.2).

###  Contexto del Proyecto
*   **Objetivo:** Emulador de Game Boy Color educativo y "Clean Room".
*   **Arquitectura:** H铆brida. Python (orquestaci贸n/UI con Pygame) + C++ (N煤cleo CPU/PPU/MMU/Timer) unidos por **Cython**.
*   **Estado Actual:** Fase 2 (Migraci贸n a C++).
    *   **Logros:** CPU nativa, PPU con modos y renderizado b谩sico, MBC1 implementado, DMA implementado.
    *   **Juegos:** *Tetris* (corre sin gr谩ficos por LCD off), *Mario Deluxe* (corre), *Pok茅mon Red* (corre pero crashea).

### 锔 Flujo de Trabajo Estricto (Protocolo de Interacci贸n)
Nuestro m茅todo de trabajo es triangular y requiere precisi贸n absoluta:
1.  **T煤 (IA)**: Analizas la situaci贸n y generas un **Mega Prompt** estructurado.
2.  **Yo (Usuario)**: Copio tu prompt y se lo pego a **Cursor IDE** (otra IA que edita el c贸digo).
3.  **Yo**: Te devuelvo a ti el output de la terminal, los logs o los errores que Cursor gener贸.
4.  **T煤**: Analizas los resultados y planeas el siguiente paso.

###  Reglas de Oro para tus Respuestas
1.  **Git Obligatorio**: Al final de CADA paso, debes proporcionar los comandos exactos: `git add .`, `git commit -m "..."`, `git push`.
2.  **Bit谩cora Sagrada**: Cada paso t茅cnico debe generar:
    *   Una entrada `.html` en `docs/bitacora/entries/`.
    *   Una actualizaci贸n en `docs/bitacora/index.html`.
    *   Una actualizaci贸n en `INFORME_FASE_2.md`.
    *   *Nota*: Debes recordar a Cursor que incluya la **informaci贸n acad茅mica** (el "porqu茅" t茅cnico) en la bit谩cora HTML.
3.  **Compilaci贸n**: Recuerda siempre el comando `.\rebuild_cpp.ps1` antes de probar.
4.  **Clean Room**: Cita Pan Docs o GBEDG. Nunca sugieras mirar c贸digo de otros emuladores.

###  La Situaci贸n Cr铆tica Actual (Debugging Pok茅mon Red)
Estamos depurando un **Crash en Pok茅mon Red**:
*   **S铆ntoma**: Bucle infinito en `RST 38` (`PC:0038`). El Stack Pointer (`SP`) cae en picada (Stack Overflow).
*   **Diagn贸stico Previo**:
    1.  El `SP` apuntaba a ROM (`210A`). Arreglado implementando Stack Math (`0xE8`, `0xF8`).
    2.  El `SP` apuntaba a basura por falta de control de flujo. Arreglado implementando saltos condicionales y `PUSH/POP`.
    3.  **Diagn贸stico Actual**: El emulador sigue cayendo en `RST 38` (`Opcode 0xFF`). Esto suele ocurrir por **"Fall-Through"** en una interrupci贸n. Si la instrucci贸n **`RETI` (0xD9)** falta, la CPU no retorna de la ISR, sigue ejecutando memoria vac铆a (`0xFF`) y crashea.

###  Archivos Clave (Se adjuntar谩n)
*   `src/core/cpp/CPU.cpp`: El cerebro. Aqu铆 estamos implementando opcodes.
*   `src/core/cpp/MMU.cpp`: Memoria y DMA.
*   `INFORME_FASE_2.md`: El historial de batalla.
```

---

###  BLOQUE 2: La Tarea Inmediata (Ejemplo de Formato)

###  Tu Primera Misi贸n: Step 0272
Necesitamos confirmar si falta `RETI` y atrapar cualquier otro opcode faltante.

Por favor, genera el **Prompt para Cursor** siguiendo este formato exacto (Ejemplo de como lo quiero):

--- EJEMPLO DE FORMATO (No ejecutes esto, es solo referencia) ---
# ROL: Principal Systems Engineer

## SITUACIN
[Descripci贸n t茅cnica del problema, ej: El SP se corrompe...]

## TAREA: STEP XXXX - [NOMBRE DEL STEP]
[Instrucciones precisas de qu茅 c贸digo C++ modificar]

### 1. Implementaci贸n en `CPU.cpp`
```cpp
// C贸digo exacto a insertar
```

### 2. Documentaci贸n
Genera la entrada de bit谩cora explicando [Concepto Acad茅mico, ej: C贸mo funciona el registro F].

## ENTREGABLES
1. C贸digo modificado.
2. Bit谩cora HTML y MD.
---------------------------------------------------------------

**Tu Tarea Real ahora es generar el prompt para el Step 0272:**
1.  **Implementar `RETI` (Opcode `0xD9`)**: Retorno de interrupci贸n + Habilitar IME.
2.  **Instrumentar `default` case**: A帽adir un `printf` de advertencia ("CPU WARNING") cuando se encuentre un opcode desconocido, en lugar de fallar silenciosamente.

Espero tu prompt para pas谩rselo a Cursor. Confirma que has entendido el flujo.
```

---
