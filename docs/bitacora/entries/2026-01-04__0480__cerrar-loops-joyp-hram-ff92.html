<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 0480: Cerrar Loops JOYP y HRAM FF92 + Arreglar Parser - Viboy Color</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Step 0480: Cerrar Loops JOYP y HRAM FF92 + Arreglar Parser</h1>
            <p><a href="../index.html" class="back-link">← Volver al índice</a></p>
            
            <div class="entry-meta">
                <span><strong>Fecha:</strong> 2026-01-04</span>
                <span><strong>Step ID:</strong> 0480</span>
                <span><strong>Estado:</strong> <span class="tag tag-verified">VERIFIED</span></span>
            </div>
        </header>

        <main>
            <section class="summary">
                <h2>Resumen Ejecutivo</h2>
                <p>
                    Step 0479 identificó que mario.gbc espera 0xFF92 (HRAM, no I/O) y tetris_dx.gbc espera 0xFF00 (JOYP). Step 0480 corrige el parser para evitar falsos positivos (FF92=HRAM), implementa instrumentación quirúrgica de HRAM[FF92], corrige semántica JOYP (bits 6-7 siempre 1), y mejora disasm_window para marcar PC y respetar banking.
                </p>
                <p>
                    <strong>Resultado:</strong> ✅ Parser corregido (distingue I/O vs HRAM). ✅ Instrumentación HRAM[FF92] funcionando. ✅ Semántica JOYP corregida. ✅ Tests clean-room (3/3 pasando). ✅ Disasm mejorado. ✅ Reporte generado: HRAM[FF92] nunca se escribe (valor 0 es inicial), JOYP fix no desbloquea tetris_dx aún (requiere más investigación).
                </p>
            </section>

            <section class="hardware-concept">
                <h2>Concepto de Hardware</h2>
                
                <h3>HRAM (High RAM) en Game Boy</h3>
                <p>
                    HRAM es una región de memoria de 127 bytes (0xFF80-0xFFFE) que es accesible rápidamente por la CPU. A diferencia de los registros I/O (0xFF00-0xFF7F), HRAM es memoria normal que se puede leer y escribir sin efectos secundarios.
                </p>
                <p>
                    <strong>Fuente:</strong> Pan Docs - Memory Map
                </p>

                <h3>JOYP Register (0xFF00)</h3>
                <p>
                    El registro JOYP (P1) controla el input del joypad. Según Pan Docs, los bits 6-7 siempre leen como 1, independientemente del valor escrito. Los bits 4-5 seleccionan qué fila de botones leer (direcciones o acciones), y los bits 0-3 reflejan el estado de los botones (0 = presionado, 1 = suelto).
                </p>
                <p>
                    <strong>Fuente:</strong> Pan Docs - Joypad Input, P1 Register
                </p>
            </section>

            <section class="implementation">
                <h2>Implementación</h2>
                
                <h3>Fase A: Corregir Parser</h3>
                <p>
                    El parser `parse_loop_io_pattern` ahora distingue correctamente entre:
                </p>
                <ul>
                    <li><strong>I/O registers (0xFF00-0xFF7F):</strong> Detectados como wait loops si hay LDH A,(addr) con addr < 0xFF80, seguido de AND/BIT/CP y JR/JP de vuelta al hotspot.</li>
                    <li><strong>HRAM (0xFF80-0xFFFF):</strong> NO detectados como wait loops (evita falsos positivos como 0xFF92).</li>
                </ul>

                <h3>Fase B: Instrumentación HRAM[FF92]</h3>
                <p>
                    Añadida instrumentación quirúrgica en MMU para trackear reads/writes a 0xFF92:
                </p>
                <ul>
                    <li>Contadores de writes y reads (solo desde programa, no CPU poll)</li>
                    <li>Último PC, valor y timestamp de write</li>
                    <li>Último PC y valor de read</li>
                    <li>Gated por <code>VIBOY_DEBUG_IO=1</code></li>
                </ul>

                <h3>Fase C: Semántica JOYP</h3>
                <p>
                    Corregida semántica de JOYP en MMU::read(0xFF00):
                </p>
                <ul>
                    <li>Bits 6-7 siempre leen como 1 (según Pan Docs)</li>
                    <li>Valor por defecto: 0xFF (todos los bits en 1 = no presionados)</li>
                </ul>

                <h3>Fase D: Disasm Mejorado</h3>
                <p>
                    Mejorado `disasm_window` en `tools/rom_smoke_0442.py`:
                </p>
                <ul>
                    <li>Marca el PC actual con <code>>>> ... <<< PC ACTUAL</code></li>
                    <li>Respeta banking al leer bytes de ROM (usa MMU en lugar de raw file reads)</li>
                    <li>Evita "DB" (data byte) garbage en el disassembly</li>
                </ul>
            </section>

            <section class="tests">
                <h2>Tests y Verificación</h2>
                
                <h3>Tests Clean-Room</h3>
                <p>
                    Creados 3 tests nuevos para validar semántica JOYP:
                </p>
                <ul>
                    <li><code>test_joyp_default_no_input_returns_1s_0480.py</code>: Verifica que JOYP con sin input devuelve bits 0-1 en 1</li>
                    <li><code>test_joyp_select_buttons_affects_low_nibble_0480.py</code>: Verifica que seleccionar fila de botones afecta el nibble bajo</li>
                    <li><code>test_joyp_select_dpad_affects_low_nibble_0480.py</code>: Verifica que seleccionar fila de direcciones afecta el nibble bajo</li>
                </ul>
                <p>
                    <strong>Resultado:</strong> ✅ 3/3 tests pasando
                </p>

                <h3>Ejecución rom_smoke</h3>
                <p>
                    Ejecutado <code>rom_smoke_0442.py</code> con baseline limpio para 3 ROMs:
                </p>
                <ul>
                    <li><code>mario.gbc</code>: 240 frames</li>
                    <li><code>tetris_dx.gbc</code>: 240 frames</li>
                    <li><code>tetris.gb</code>: 240 frames</li>
                </ul>
                <p>
                    <strong>Flags:</strong> <code>VIBOY_SIM_BOOT_LOGO=0 VIBOY_DEBUG_IO=1 VIBOY_DEBUG_INJECTION=0 VIBOY_AUTOPRESS=0 VIBOY_FORCE_BGP=0 VIBOY_FRAMEBUFFER_TRACE=0</code>
                </p>
            </section>

            <section class="results">
                <h2>Resultados</h2>
                
                <h3>mario.gbc</h3>
                <ul>
                    <li>✅ HRAM[FF92] instrumentación funcionando</li>
                    <li>❌ HRAM[FF92] NUNCA se escribe (contador permanece en 0)</li>
                    <li>⚠️ HRAM[FF92] no se lee desde programa (todas las lecturas son desde CPU poll)</li>
                    <li><strong>Conclusión:</strong> HRAM[FF92] se lee pero nunca se escribe. El valor 0 es el valor inicial (HRAM se inicializa a 0x00).</li>
                </ul>

                <h3>tetris_dx.gbc</h3>
                <ul>
                    <li>❌ Loop JOYP NO detectado por el parser (requiere más investigación)</li>
                    <li>✅ JOYP semántica corregida (bits 6-7 siempre 1)</li>
                    <li><strong>Conclusión:</strong> El fix de JOYP no desbloquea el loop aún. Requiere más investigación sobre la condición exacta del loop.</li>
                </ul>
            </section>

            <section class="files">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>tools/rom_smoke_0442.py</code>: Parser corregido, disasm_window mejorado, métricas HRAM FF92 añadidas</li>
                    <li><code>src/core/cpp/MMU.hpp</code>: Miembros privados para instrumentación HRAM[FF92]</li>
                    <li><code>src/core/cpp/MMU.cpp</code>: Instrumentación HRAM[FF92], semántica JOYP corregida</li>
                    <li><code>tests/test_joyp_*_0480.py</code>: 3 tests nuevos para validar semántica JOYP</li>
                </ul>
            </section>

            <section class="integrity">
                <h2>Integridad Educativa</h2>
                <div class="integrity">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>HRAM vs I/O:</strong> HRAM (0xFF80-0xFFFF) es memoria normal, no registros I/O. El parser debe distinguir entre ambos para evitar falsos positivos.</li>
                        <li><strong>JOYP Semantics:</strong> Los bits 6-7 de JOYP siempre leen como 1 según Pan Docs. Esto es crítico para la semántica correcta del registro.</li>
                        <li><strong>Disasm Banking:</strong> Al desensamblar código, se debe respetar el banking de ROM usando MMU en lugar de raw file reads para evitar "DB" garbage.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>HRAM[FF92] en mario.gbc:</strong> Por qué se lee pero nunca se escribe. Puede ser que el valor 0 sea suficiente o que se escriba en un momento no capturado.</li>
                        <li><strong>JOYP Loop en tetris_dx.gbc:</strong> Por qué el parser no detecta el loop JOYP. Puede requerir ajustes en el algoritmo de detección o la condición es más compleja.</li>
                    </ul>
                </div>
            </section>

            <section class="next-steps">
                <h2>Próximos Pasos</h2>
                <ul>
                    <li>[ ] Investigar por qué HRAM[FF92] nunca se escribe en mario.gbc - puede ser que el valor 0 sea suficiente</li>
                    <li>[ ] Investigar por qué el parser no detecta el loop JOYP en tetris_dx.gbc - puede requerir ajustes en el algoritmo</li>
                    <li>[ ] Aplicar fixes adicionales según evidencia una vez identificada la causa raíz</li>
                </ul>
            </section>
        </main>

        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia código de otros emuladores. Basado únicamente en documentación técnica.</p>
        </footer>
    </div>
</body>
</html>