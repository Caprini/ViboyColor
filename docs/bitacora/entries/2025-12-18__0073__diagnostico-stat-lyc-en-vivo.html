<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de STAT/LYC en Vivo - Viboy Color Bit√°cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>‚ö†Ô∏è Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c√≥digo de otros emuladores. Implementaci√≥n basada √∫nicamente en documentaci√≥n t√©cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Diagn√≥stico de STAT/LYC en Vivo</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-18
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0073
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-draft">Draft</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-18__0072__verificacion-tests-stat-interrupts.html">Anterior</a></li>
                    <li><a href="2025-12-18__0074__mejora-actualizacion-stat-bit2-write-internal.html">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Se a√±adi√≥ instrumentaci√≥n de diagn√≥stico en tiempo real para detectar configuraciones de LYC y STAT,
                    y para identificar cu√°ndo la PPU detecta se√±ales de interrupci√≥n STAT activas. El objetivo es diagnosticar
                    por qu√© juegos como Pok√©mon y Tetris se quedan congelados en el logo: los logs muestran muchas interrupciones
                    V-Blank (0x0040) pero ninguna interrupci√≥n STAT (0x0048), lo que sugiere que el juego espera una interrupci√≥n
                    STAT (LY=LYC) para animar el logo pero no se est√° disparando.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    La Game Boy puede generar interrupciones STAT (LCD Status) cuando se cumplen ciertas condiciones relacionadas
                    con el estado de la PPU. Una de estas condiciones es la <strong>coincidencia LYC=LY</strong>: cuando el registro
                    LY (L√≠nea actual) coincide con el registro LYC (LY Compare), se puede generar una interrupci√≥n si el bit 6
                    del registro STAT est√° activo.
                </p>
                <p>
                    Muchos juegos usan esta caracter√≠stica para animar el logo durante la intro: configuran LYC a un valor espec√≠fico
                    (por ejemplo, l√≠nea 144 para V-Blank o una l√≠nea visible para efectos especiales), habilitan la interrupci√≥n
                    STAT en IE (bit 1) y en STAT (bit 6), y esperan a que se dispare la interrupci√≥n para actualizar los gr√°ficos.
                </p>
                <p>
                    Si la interrupci√≥n STAT no se dispara, el juego se queda esperando indefinidamente en un bucle, causando que
                    la pantalla se congele en el logo.
                </p>
                <p>
                    <strong>Fuente:</strong> Pan Docs - LCD Status Register (STAT), LYC Register, STAT Interrupt
                </p>
            </section>

            <!-- 3. Implementaci√≥n -->
            <section id="implementacion">
                <h2>Implementaci√≥n</h2>
                <p>
                    Se a√±adi√≥ instrumentaci√≥n de diagn√≥stico en tres puntos clave del sistema:
                </p>
                
                <h3>1. Instrumentaci√≥n en MMU (escrituras a LYC y STAT)</h3>
                <p>
                    En <code>src/memory/mmu.py</code>, se a√±adieron logs informativos cuando el juego escribe en:
                </p>
                <ul>
                    <li><strong>LYC (0xFF45):</strong> Se registra el valor escrito con el log <code>üëÅÔ∏è LYC SET: {value}</code></li>
                    <li><strong>STAT (0xFF41):</strong> Se registra el valor escrito y qu√© bits de interrupci√≥n est√°n habilitados:
                        <ul>
                            <li>Bit 3: H-Blank Interrupt Enable</li>
                            <li>Bit 4: V-Blank Interrupt Enable</li>
                            <li>Bit 5: OAM Search Interrupt Enable</li>
                            <li>Bit 6: LYC=LY Coincidence Interrupt Enable</li>
                        </ul>
                    </li>
                </ul>

                <h3>2. Instrumentaci√≥n en PPU (detecci√≥n de se√±al STAT activa)</h3>
                <p>
                    En <code>src/gpu/ppu.py</code>, en el m√©todo <code>_check_stat_interrupt()</code>, se a√±adieron logs cuando
                    se detecta una se√±al STAT activa por cualquiera de las condiciones:
                </p>
                <ul>
                    <li><strong>LYC Match:</strong> Cuando LY == LYC y el bit 6 de STAT est√° activo</li>
                    <li><strong>H-Blank:</strong> Cuando el modo es Mode 0 y el bit 3 de STAT est√° activo</li>
                    <li><strong>V-Blank:</strong> Cuando el modo es Mode 1 y el bit 4 de STAT est√° activo</li>
                    <li><strong>OAM Search:</strong> Cuando el modo es Mode 2 y el bit 5 de STAT est√° activo</li>
                </ul>
                <p>
                    El log incluye informaci√≥n completa: modo PPU, LY actual, LYC configurado, valor de STAT, y qu√© condici√≥n
                    activ√≥ la se√±al.
                </p>

                <h3>3. Verificaci√≥n del Dispatcher de Interrupciones</h3>
                <p>
                    Se verific√≥ que el dispatcher de interrupciones en <code>src/cpu/core.py</code> chequea correctamente el bit 1
                    de IF para la interrupci√≥n STAT y salta al vector 0x0048. La implementaci√≥n es correcta y sigue la prioridad
                    de interrupciones del hardware (V-Blank tiene prioridad m√°s alta que STAT).
                </p>

                <h3>Decisiones de dise√±o</h3>
                <p>
                    Los logs se a√±adieron con nivel <code>INFO</code> para que sean visibles durante la ejecuci√≥n normal del emulador.
                    Esto permite diagnosticar problemas en tiempo real sin necesidad de activar logging DEBUG, que puede ser muy verboso.
                </p>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/memory/mmu.py</code> - A√±adida instrumentaci√≥n para escrituras a LYC (0xFF45) y STAT (0xFF41)</li>
                    <li><code>src/gpu/ppu.py</code> - A√±adida instrumentaci√≥n para detecci√≥n de se√±al STAT activa en <code>_check_stat_interrupt()</code></li>
                </ul>
            </section>

            <!-- 5. Tests y Verificaci√≥n -->
            <section id="tests">
                <h2>Tests y Verificaci√≥n</h2>
                <p>
                    Esta es una implementaci√≥n de <strong>diagn√≥stico</strong>, no una funcionalidad nueva. La instrumentaci√≥n
                    se a√±adi√≥ para ayudar a identificar por qu√© los juegos se quedan congelados.
                </p>
                <p>
                    <strong>Pr√≥ximos pasos para verificaci√≥n:</strong>
                </p>
                <ul>
                    <li>Ejecutar <code>python main.py pkmn.gb</code> o <code>python main.py tetris_dx.gbc</code></li>
                    <li>Buscar en los logs:
                        <ul>
                            <li>Si aparece <code>üëÅÔ∏è LYC SET</code>: El juego est√° configurando LYC</li>
                            <li>Si aparece <code>üëÅÔ∏è STAT WRITE</code>: El juego est√° configurando STAT</li>
                            <li>Si aparece <code>üö® STAT SIGNAL ACTIVE</code>: La PPU detecta el evento</li>
                            <li>Si aparece lo anterior pero NO aparece <code>‚ö° INTERRUPT DISPATCHED! Vector: 0048</code>:
                                El fallo est√° en el dispatcher de interrupciones (CPU)</li>
                        </ul>
                    </li>
                </ul>
                <p>
                    <strong>Estado:</strong> <span class="tag tag-draft">Draft</span> - Pendiente de ejecutar y analizar los logs
                    para identificar el problema exacto.
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/LCDC_Registers.html#lcd-status-register-stat-ff41">LCD Status Register (STAT)</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/LCDC_Registers.html#lyc-ly-compare-ff45">LYC Register (LY Compare)</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Interrupts.html">Interrupts</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Interrupciones STAT:</strong> La Game Boy puede generar interrupciones cuando se cumplen condiciones
                            espec√≠ficas relacionadas con el estado de la PPU (modo, LYC=LY, etc.).</li>
                        <li><strong>LYC=LY Coincidence:</strong> Cuando LY coincide con LYC, se puede generar una interrupci√≥n si el
                            bit 6 de STAT est√° activo. Esto es √∫til para sincronizar actualizaciones gr√°ficas con l√≠neas espec√≠ficas.</li>
                        <li><strong>Rising Edge Detection:</strong> Las interrupciones STAT se disparan en "rising edge", es decir,
                            solo cuando la condici√≥n pasa de False a True, no mientras permanece True.</li>
                        <li><strong>Prioridad de Interrupciones:</strong> V-Blank tiene prioridad m√°s alta que STAT. Si ambas est√°n
                            pendientes, V-Blank se procesa primero.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Configuraci√≥n del juego:</strong> ¬øEl juego est√° configurando LYC y STAT correctamente?
                            Los logs nos dir√°n si el juego escribe en estos registros.</li>
                        <li><strong>Detecci√≥n de se√±al:</strong> ¬øLa PPU est√° detectando la coincidencia LY==LYC?
                            Los logs nos dir√°n si se activa la se√±al STAT.</li>
                        <li><strong>Dispatcher de interrupciones:</strong> ¬øEl dispatcher est√° chequeando correctamente el bit 1 de IF?
                            Ya verificamos el c√≥digo y parece correcto, pero los logs confirmar√°n si se dispara la interrupci√≥n.</li>
                        <li><strong>Habilitaci√≥n en IE:</strong> ¬øEl juego est√° habilitando la interrupci√≥n STAT en IE (bit 1)?
                            Si no est√° habilitada en IE, la interrupci√≥n no se procesar√° aunque IF tenga el bit activo.</li>
                    </ul>

                    <h3>Hip√≥tesis y Suposiciones</h3>
                    <p>
                        <strong>Hip√≥tesis principal:</strong> El juego est√° configurando LYC y STAT correctamente, pero la interrupci√≥n
                        STAT no se est√° disparando porque:
                    </p>
                    <ul>
                        <li>La PPU no est√° detectando la coincidencia LY==LYC (problema en <code>_check_stat_interrupt()</code>)</li>
                        <li>El juego no est√° habilitando la interrupci√≥n STAT en IE (bit 1)</li>
                        <li>Hay un problema con el rising edge detection que impide que se dispare m√∫ltiples veces</li>
                    </ul>
                    <p>
                        Los logs nos dir√°n exactamente d√≥nde est√° el problema.
                    </p>
                </div>
            </section>

            <!-- 8. Pr√≥ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr√≥ximos Pasos</h2>
                <ul>
                    <li>[ ] Ejecutar el emulador con una ROM (pkmn.gb o tetris_dx.gbc) y analizar los logs</li>
                    <li>[ ] Identificar si el juego configura LYC y STAT (buscar <code>üëÅÔ∏è LYC SET</code> y <code>üëÅÔ∏è STAT WRITE</code>)</li>
                    <li>[ ] Identificar si la PPU detecta la se√±al STAT (buscar <code>üö® STAT SIGNAL ACTIVE</code>)</li>
                    <li>[ ] Identificar si se dispara la interrupci√≥n STAT (buscar <code>‚ö° INTERRUPT DISPATCHED! Vector: 0048</code>)</li>
                    <li>[ ] Corregir el problema identificado en los logs</li>
                    <li>[ ] Verificar que el juego ya no se congela y avanza correctamente</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia c√≥digo de otros emuladores. Basado √∫nicamente en documentaci√≥n t√©cnica.</p>
        </footer>
    </div>
</body>
</html>

