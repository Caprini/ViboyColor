<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajuste de Coordenadas: Centrado del Logo - Viboy Color Bitácora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>⚠️ Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia código de otros emuladores. Implementación basada únicamente en documentación técnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Ajuste de Coordenadas: Centrado del Logo</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-21
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0207
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-verified">✅ VERIFIED</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-21__0206__despertar-vram-inyeccion-tiles-2bpp-formato-correcto.html">Anterior (0206)</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    El análisis del Step 0206 reveló un error de cálculo geométrico en la posición del logo. El tilemap se colocó en la dirección `0x9A00` (Fila 16), lo que situaba el logo en el borde inferior de la pantalla, fuera del área de muestreo de los logs y difícil de ver. Corregimos la dirección del tilemap a `0x9904` (Fila 8, Columna 4), colocando el logo en el centro absoluto de la pantalla, haciéndolo visible y detectable por los logs.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware: El Mapa de Tiles (Tilemap)</h2>
                <p>
                    La Game Boy tiene una pantalla de 20×18 tiles (160×144 píxeles). El mapa de fondo (`0x9800`) es una cuadrícula de 32×32 tiles, donde cada byte representa el ID del tile que debe renderizarse en esa posición.
                </p>
                <p>
                    <strong>Cálculo de direcciones del Tilemap:</strong>
                </p>
                <ul>
                    <li><strong>Base del Tilemap:</strong> `0x9800`</li>
                    <li><strong>Fila 0:</strong> `0x9800` (inicio del mapa)</li>
                    <li><strong>Fila 8 (Centro Y):</strong> `0x9800 + (8 × 32) = 0x9900`</li>
                    <li><strong>Columna 4 (Centro X aprox):</strong> `0x9900 + 4 = 0x9904`</li>
                </ul>
                <p>
                    <strong>El error del Step 0206:</strong> El código comentaba "Fila 8" pero usaba la dirección `0x9A00`. Realizando el cálculo inverso: `0x9A00 - 0x9800 = 0x200 = 512 bytes = 16 filas`. Esto significa que el logo se dibujó en la Fila 16, muy cerca del borde inferior de la pantalla (144 píxeles = 18 filas de tiles). El sistema de logs muestrea los píxeles del centro de la pantalla (aproximadamente Fila 9), por lo que al estar el logo en la Fila 16, el log leía la Fila 9, que estaba vacía (Color 0), mostrando `muestra índices: [0, 0, 0, 0, 0, 0]`.
                </p>
                <p>
                    <strong>La corrección:</strong> Al escribir nuestro mapa en `0x9904`, el logo aparecerá centrado verticalmente (Fila 8 de 18) y horizontalmente (Columna 4 de 32, con el logo ocupando las columnas 7-12).
                </p>
                <p>
                    <strong>Fuente:</strong> Pan Docs - "Tile Map", "Background"
                </p>
            </section>

            <!-- 3. Implementación -->
            <section id="implementacion">
                <h2>Implementación</h2>
                <p>
                    Corregimos la dirección de destino del tilemap en el constructor de `MMU` para colocar el logo en el centro de la pantalla.
                </p>
                
                <h3>Modificación en MMU.cpp</h3>
                <p>
                    En `src/core/cpp/MMU.cpp`, dentro del constructor `MMU::MMU()`, cambiamos la dirección de destino del tilemap de `0x9A00` a `0x9904`:
                </p>
                <pre><code>// 2. Cargar Tilemap del Logo en VRAM Map (0x9904 - Fila 8, Columna 4, centrado)
// CORRECCIÓN Step 0207: Usar 0x9904 para centrar en Fila 8, Columna 4.
// Antes estaba en 0x9A00 (Fila 16), demasiado abajo y fuera del área visible.
// Cálculo: 0x9800 (base) + (8 * 32) = 0x9900 (Fila 8) + 4 = 0x9904 (centrado horizontal)
// 32 bytes = 1 fila completa del mapa de tiles (32 tiles horizontales)
for (size_t i = 0; i < sizeof(VIBOY_LOGO_MAP); ++i) {
    memory_[0x9904 + i] = VIBOY_LOGO_MAP[i];
}</code></pre>

                <h3>Componentes modificados</h3>
                <ul>
                    <li><code>src/core/cpp/MMU.cpp</code>: Corregida la dirección de destino del tilemap de `0x9A00` a `0x9904` en el constructor `MMU::MMU()`.</li>
                </ul>

                <h3>Decisiones de diseño</h3>
                <ul>
                    <li><strong>Centrado vertical (Fila 8):</strong> La pantalla Game Boy tiene 18 filas visibles. Colocar el logo en la Fila 8 lo centra verticalmente (8 filas arriba, 10 filas abajo).</li>
                    <li><strong>Centrado horizontal (Columna 4):</strong> El tilemap tiene 32 columnas. Al empezar en la Columna 4, el logo (6 tiles) ocupa las columnas 7-12, quedando aproximadamente centrado en la pantalla de 20 columnas visibles.</li>
                </ul>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/core/cpp/MMU.cpp</code> - Corregida la dirección de destino del tilemap de `0x9A00` a `0x9904`.</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificación -->
            <section id="tests">
                <h2>Tests y Verificación</h2>
                <p>
                    Validación de módulo compilado C++:
                </p>
                <ul>
                    <li><strong>Recompilación:</strong> Ejecutado <code>.\rebuild_cpp.ps1</code> para recompilar el módulo C++ con la corrección.</li>
                    <li><strong>Ejecución del emulador:</strong> Ejecutado <code>python main.py roms/tetris.gb</code> para verificar visualmente que el logo aparece centrado.</li>
                    <li><strong>Logs esperados:</strong> El log <code>[Renderer] Frame #0</code> ahora debería mostrar índices distintos de cero (ej: <code>[3, 3, 2, 0...]</code>), confirmando que la PPU está leyendo los datos del logo desde la posición correcta.</li>
                </ul>
                <p>
                    <strong>Resultado esperado:</strong>
                </p>
                <ul>
                    <li><strong>Visual:</strong> El logo "VIBOY COLOR" aparece perfectamente centrado en la pantalla.</li>
                    <li><strong>Logs:</strong> Los logs muestran índices de color distintos de cero en el centro de la pantalla, confirmando que el logo es visible y detectable.</li>
                </ul>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Tile_Data.html">Tile Data</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Tile_Map.html">Tile Map</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Background.html">Background</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Cálculo de direcciones del Tilemap:</strong> El tilemap es una cuadrícula de 32×32 tiles. Para calcular la dirección de una posición específica (fila, columna), usamos: `0x9800 + (fila × 32) + columna`. El error del Step 0206 fue un simple error aritmético: `0x9A00` corresponde a la Fila 16, no a la Fila 8.</li>
                        <li><strong>Área visible vs área total:</strong> La pantalla Game Boy muestra solo 20×18 tiles de los 32×32 tiles del tilemap. El resto del mapa puede usarse para scroll o efectos especiales. Al colocar el logo en la Fila 16, estaba técnicamente dentro del mapa, pero muy cerca del borde inferior, fuera del área de muestreo de los logs.</li>
                        <li><strong>Debugging geométrico:</strong> Cuando los logs muestran valores inesperados (todos ceros), no siempre es un problema de emulación. Puede ser un error de cálculo de coordenadas o de posicionamiento de datos. Verificar los cálculos matemáticos es tan importante como verificar la lógica de emulación.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Verificación visual:</strong> Confirmar que el logo aparece efectivamente centrado en la pantalla cuando se ejecuta el emulador.</li>
                        <li><strong>Verificación de logs:</strong> Confirmar que los logs muestran índices distintos de cero en el centro de la pantalla, indicando que el logo es detectable.</li>
                    </ul>

                    <h3>Hipótesis y Suposiciones</h3>
                    <p>
                        Asumimos que el sistema de logs muestrea los píxeles del centro de la pantalla (aproximadamente Fila 9). Si el logo está en la Fila 8, debería ser visible en los logs. Si no aparece, puede ser necesario ajustar el área de muestreo de los logs o verificar que el logo se está renderizando correctamente.
                    </p>
                </div>
            </section>

            <!-- 8. Próximos Pasos -->
            <section id="proximos-pasos">
                <h2>Próximos Pasos</h2>
                <ul>
                    <li>[ ] Verificar visualmente que el logo aparece centrado en la pantalla</li>
                    <li>[ ] Confirmar que los logs muestran índices distintos de cero en el centro de la pantalla</li>
                    <li>[ ] Si el logo aún no es visible, investigar otros posibles problemas (paleta de colores, configuración de LCDC, etc.)</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia código de otros emuladores. Basado únicamente en documentación técnica.</p>
        </footer>
    </div>
</body>
</html>

