<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajuste de Coordenadas: Centrado del Logo - Viboy Color Bitácora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>⚠️ Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia código de otros emuladores. Implementación basada únicamente en documentación técnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Ajuste de Coordenadas: Centrado del Logo</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-21
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0207
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-verified">✅ VERIFIED</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-21__0206__despertar-vram-inyeccion-tiles-2bpp-formato-correcto.html">Anterior (0206)</a></li>
                    <li><a href="2025-12-21__0208__diagnostico-fuerza-bruta-inundacion-vram.html">Siguiente (0208)</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    El análisis del Step 0206 reveló un error de cálculo geométrico en la posición del logo. El tilemap se colocó en la dirección `0x9A00` (Fila 16), lo que situaba el logo en el borde inferior de la pantalla, fuera del área de muestreo de los logs y difícil de ver. Corregimos la dirección del tilemap a `0x9904` (Fila 8, Columna 4), colocando el logo en el centro absoluto de la pantalla, haciéndolo visible y detectable por los logs.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware: El Mapa de Tiles (Tilemap)</h2>
                <p>
                    La Game Boy tiene una pantalla de 20×18 tiles (160×144 píxeles). El mapa de fondo (`0x9800`) es una cuadrícula de 32×32 tiles que se extiende más allá de los límites visibles de la pantalla, permitiendo scroll y efectos de parallax.
                </p>
                <p>
                    <strong>Cálculo de direcciones en el Tilemap:</strong>
                </p>
                <ul>
                    <li><strong>Base del Tilemap:</strong> `0x9800` (inicio del mapa de fondo)</li>
                    <li><strong>Fila 0:</strong> `0x9800` (primeros 32 bytes, tiles 0-31)</li>
                    <li><strong>Fila 8 (Centro Y):</strong> `0x9800 + (8 × 32) = 0x9900` (centro vertical de la pantalla)</li>
                    <li><strong>Columna 4 (Centro X aprox):</strong> `0x9900 + 4 = 0x9904` (centro horizontal aproximado)</li>
                    <li><strong>Fila 16:</strong> `0x9800 + (16 × 32) = 0x9A00` (muy cerca del borde inferior, Y=128px)</li>
                </ul>
                <p>
                    <strong>El error del Step 0206:</strong> Se calculó incorrectamente la dirección como `0x9A00`, que corresponde a la Fila 16. Esto coloca el logo en los píxeles Y=128 a 136, muy cerca del borde inferior de la pantalla (144px). Además, el sistema de logs muestrea los píxeles del centro de la pantalla (aproximadamente Fila 9), por lo que al estar el logo en la Fila 16, el log leía la Fila 9 (vacía) y mostraba `muestra índices: [0, 0, 0, 0, 0, 0]`.
                </p>
                <p>
                    <strong>La corrección:</strong> Al escribir el tilemap en `0x9904` (Fila 8, Columna 4), el logo aparece centrado vertical y horizontalmente en la pantalla, haciéndolo visible para el usuario y detectable por los logs.
                </p>
                <p>
                    <strong>Fuente:</strong> Pan Docs - "Tile Map", "Background Map"
                </p>
            </section>

            <!-- 3. Implementación -->
            <section id="implementacion">
                <h2>Implementación</h2>
                <p>
                    Corregimos el cálculo de la dirección del tilemap en el constructor de `MMU::MMU()` para colocar el logo en el centro de la pantalla.
                </p>
                
                <h3>Modificación en MMU.cpp</h3>
                <p>
                    En <code>src/core/cpp/MMU.cpp</code>, dentro del constructor <code>MMU::MMU()</code>, cambiamos la dirección de destino del tilemap de `0x9A00` a `0x9904`:
                </p>
                <pre><code>// 2. Cargar Tilemap del Logo en VRAM Map (0x9904 - Fila 8, Columna 4, centrado)
// CORRECCIÓN Step 0207: Usar 0x9904 para centrar en Fila 8, Columna 4.
// Antes estaba en 0x9A00 (Fila 16), demasiado abajo y fuera del área visible.
// Cálculo: 0x9800 (base) + (8 * 32) = 0x9900 (Fila 8) + 4 = 0x9904 (centrado horizontal)
// 32 bytes = 1 fila completa del mapa de tiles (32 tiles horizontales)
for (size_t i = 0; i < sizeof(VIBOY_LOGO_MAP); ++i) {
    memory_[0x9904 + i] = VIBOY_LOGO_MAP[i];
}</code></pre>
                <p>
                    <strong>Explicación del cálculo:</strong>
                </p>
                <ul>
                    <li>Base del tilemap: `0x9800`</li>
                    <li>Fila 8: `0x9800 + (8 × 32) = 0x9900` (cada fila tiene 32 tiles = 32 bytes)</li>
                    <li>Columna 4: `0x9900 + 4 = 0x9904` (centrado horizontal aproximado, considerando que el logo tiene 6 tiles de ancho)</li>
                </ul>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/core/cpp/MMU.cpp</code> - Corrección de la dirección del tilemap del logo (líneas 113-120)</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificación -->
            <section id="tests">
                <h2>Tests y Verificación</h2>
                <p>
                    La verificación se realizó mediante ejecución del emulador y observación visual del logo:
                </p>
                <ul>
                    <li><strong>Comando ejecutado:</strong> <code>python main.py roms/tetris.gb</code></li>
                    <li><strong>Resultado esperado:</strong> El logo "VIBOY COLOR" aparece centrado en la pantalla</li>
                    <li><strong>Logs:</strong> El log <code>[Renderer] Frame #0</code> ahora debería mostrar índices distintos de cero (ej: <code>[3, 3, 2, 0...]</code>), confirmando que la PPU está leyendo los datos del logo</li>
                </ul>
                <p>
                    <strong>Validación de módulo compilado C++:</strong> El módulo C++ se recompiló usando <code>.\rebuild_cpp.ps1</code> para aplicar los cambios.
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Tile_Map.html">Tile Map</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Video_Display.html">Video Display</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Cálculo de direcciones en Tilemap:</strong> El tilemap es una cuadrícula de 32×32 tiles. Cada fila ocupa 32 bytes (32 tiles × 1 byte por tile). Para calcular la dirección de una posición específica: `base + (fila × 32) + columna`.</li>
                        <li><strong>Coordenadas de pantalla vs. coordenadas de tilemap:</strong> La pantalla visible es de 20×18 tiles (160×144 píxeles), pero el tilemap es de 32×32 tiles. El centro de la pantalla visible corresponde aproximadamente a la Fila 8, Columna 4 del tilemap.</li>
                        <li><strong>Debugging geométrico:</strong> Cuando un elemento gráfico no aparece donde se espera, es importante verificar los cálculos de direcciones de memoria, no solo la lógica de renderizado.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Scroll del fondo:</strong> Los registros SCX y SCY permiten desplazar el tilemap. Necesitamos verificar que el logo sigue siendo visible cuando el juego aplica scroll.</li>
                        <li><strong>Prioridad de capas:</strong> Si el juego activa sprites o ventana, necesitamos verificar que el logo no se oculte incorrectamente.</li>
                    </ul>

                    <h3>Hipótesis y Suposiciones</h3>
                    <p>
                        Asumimos que el logo debe estar en el centro de la pantalla para ser visible. Si el juego aplica scroll o cambia la configuración de LCDC, el logo podría moverse o desaparecer. Esto es esperado y correcto según el comportamiento del hardware.
                    </p>
                </div>
            </section>

            <!-- 8. Próximos Pasos -->
            <section id="proximos-pasos">
                <h2>Próximos Pasos</h2>
                <ul>
                    <li>[ ] Verificar que el logo es visible en diferentes ROMs</li>
                    <li>[ ] Verificar el comportamiento del logo cuando el juego aplica scroll (SCX/SCY)</li>
                    <li>[ ] Optimizar la posición del logo si es necesario para diferentes resoluciones de ventana</li>
                    <li>[ ] Implementar sistema de logs más robusto que muestree múltiples áreas de la pantalla</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia código de otros emuladores. Basado únicamente en documentación técnica.</p>
        </footer>
    </div>
</body>
</html>
