<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hard Rebuild y Diagn贸stico de Ciclos - Viboy Color Bit谩cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>锔 Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c贸digo de otros emuladores. Implementaci贸n basada 煤nicamente en documentaci贸n t茅cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Hard Rebuild y Diagn贸stico de Ciclos</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-19
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0121
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-verified">Verified</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-19__0120__limpieza-build-verificacion-renderizado.html">Anterior</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    El usuario report贸 que segu铆a viendo el "Punto Rojo" (c贸digo antiguo del paso 116) y que LY se manten铆a en 0, a pesar de que el c贸digo fuente ya estaba actualizado. El diagn贸stico indic贸 que el binario `.pyd` no se hab铆a actualizado correctamente en Windows, posiblemente porque Python ten铆a el archivo cargado en memoria. Se implement贸 una soluci贸n radical: a帽adir un log temporal en C++ para confirmar que se ejecuta c贸digo nuevo, mejorar el diagn贸stico en Python para mostrar ciclos y LCDC, y proporcionar comandos para forzar la recompilaci贸n en Windows.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    En Windows, cuando Python importa un m贸dulo compilado (`.pyd`), el sistema operativo carga el archivo en memoria. Si intentas recompilar el m贸dulo mientras Python a煤n tiene el archivo cargado, Windows puede:
                </p>
                <ul>
                    <li><strong>Bloquear la escritura:</strong> El archivo est谩 en uso y no se puede sobrescribir.</li>
                    <li><strong>Permitir la escritura pero mantener la versi贸n antigua en memoria:</strong> Python sigue usando la versi贸n antigua que ya carg贸.</li>
                    <li><strong>Fallar silenciosamente:</strong> La compilaci贸n parece exitosa, pero el archivo no se actualiza.</li>
                </ul>
                <p>
                    Para forzar la actualizaci贸n, es necesario:
                </p>
                <ol>
                    <li><strong>Cerrar todas las instancias de Python</strong> que puedan tener el m贸dulo cargado.</li>
                    <li><strong>Renombrar o eliminar el archivo `.pyd` antiguo</strong> antes de recompilar.</li>
                    <li><strong>Recompilar desde cero</strong> con `python setup.py build_ext --inplace`.</li>
                </ol>
                <p>
                    Adem谩s, para diagnosticar si el c贸digo nuevo se est谩 ejecutando, a帽adimos un log temporal que se imprime la primera vez que se llama a `PPU::step()`. Si este log aparece, confirmamos que el binario se actualiz贸 correctamente.
                </p>
            </section>

            <!-- 3. Implementaci贸n -->
            <section id="implementacion">
                <h2>Implementaci贸n</h2>
                <p>
                    Se implementaron tres cambios principales:
                </p>
                
                <h3>1. Log Temporal en PPU C++</h3>
                <p>
                    Se a帽adi贸 un log temporal en `PPU::step()` que se imprime la primera vez que se llama al m茅todo. Este log confirma que el c贸digo nuevo se est谩 ejecutando:
                </p>
                <pre><code>// DIAGNSTICO TEMPORAL: Confirmar que se ejecuta c贸digo nuevo
static bool first_call = true;
if (first_call) {
    printf("[PPU C++] STEP LIVE - C贸digo actualizado correctamente\n");
    first_call = false;
}</code></pre>
                <p>
                    <strong>Nota:</strong> Este log es temporal y debe eliminarse despu茅s de verificar que funciona.
                </p>

                <h3>2. Diagn贸stico de Ciclos en Python</h3>
                <p>
                    Se a帽adi贸 una advertencia en el bucle de scanline para detectar si `line_cycles` es 0, lo que indicar铆a que la CPU no est谩 ejecutando instrucciones:
                </p>
                <pre><code># DIAGNSTICO: Verificar ciclos ejecutados en el scanline
if line_cycles == 0:
    logger.warning(f"锔 ADVERTENCIA: line_cycles=0 en scanline. CPU puede estar detenida.")</code></pre>

                <h3>3. Diagn贸stico de LCDC en Heartbeat</h3>
                <p>
                    Se mejor贸 el heartbeat para mostrar el valor de LCDC (registro 0xFF40) y si el LCD est谩 encendido o apagado:
                </p>
                <pre><code>logger.info(
    f" Heartbeat ... LY={ly_value} | LCDC=0x{lcdc_value:02X} "
    f"(LCD {'ON' if (lcdc_value & 0x80) != 0 else 'OFF'}) "
    f"| PPU {'viva' if ly_value > 0 or frame_count > 60 else 'inicializando'}"
)</code></pre>
                <p>
                    Esto permite diagnosticar si el LCD est谩 apagado (LCDC=0x00) o si hay otro problema.
                </p>

                <h3>Comandos para Forzar Recompilaci贸n en Windows</h3>
                <p>
                    Se proporcionaron comandos para forzar la recompilaci贸n:
                </p>
                <ol>
                    <li><strong>Cerrar todas las instancias de Python</strong> (terminales, IDEs, procesos en segundo plano).</li>
                    <li><strong>Renombrar el archivo `.pyd` antiguo:</strong>
                        <pre><code>ren build\lib.win-amd64-cpython-313\viboy_core.cp313-win_amd64.pyd viboy_core_OLD.pyd</code></pre>
                    </li>
                    <li><strong>Limpiar archivos compilados:</strong>
                        <pre><code>python setup.py clean --all</code></pre>
                    </li>
                    <li><strong>Recompilar:</strong>
                        <pre><code>python setup.py build_ext --inplace</code></pre>
                    </li>
                </ol>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/core/cpp/PPU.cpp</code> - A帽adido log temporal para confirmar ejecuci贸n de c贸digo nuevo</li>
                    <li><code>src/viboy.py</code> - A帽adido diagn贸stico de ciclos y LCDC en el bucle principal</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificaci贸n -->
            <section id="tests">
                <h2>Tests y Verificaci贸n</h2>
                <p>
                    La verificaci贸n se realiza ejecutando el emulador y observando:
                </p>
                <ul>
                    <li><strong>Log de confirmaci贸n:</strong> Si aparece `[PPU C++] STEP LIVE - C贸digo actualizado correctamente` en la consola, el binario se actualiz贸 correctamente.</li>
                    <li><strong>Pantalla blanca:</strong> Si el framebuffer se inicializa correctamente a `0xFFFFFFFF`, la pantalla debe ser blanca (sin punto rojo).</li>
                    <li><strong>LY avanzando:</strong> Si LY cambia de 0 a valores mayores, la PPU est谩 funcionando.</li>
                    <li><strong>LCDC cambiando:</strong> Si LCDC cambia de 0x00 a 0x91 (o similar), el juego est谩 inicializando el LCD.</li>
                </ul>
                <p>
                    <strong>Comando de prueba:</strong>
                </p>
                <pre><code>python main.py roms/tetris.gb</code></pre>
                <p>
                    <strong>Validaci贸n esperada:</strong>
                </p>
                <ul>
                    <li>Log `[PPU C++] STEP LIVE` aparece al inicio.</li>
                    <li>Pantalla blanca (sin punto rojo).</li>
                    <li>Heartbeat muestra `LY` avanzando y `LCDC` cambiando.</li>
                </ul>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Documentaci贸n de Windows: Comportamiento de archivos DLL/PDY en uso</li>
                    <li>Pan Docs: Registro LCDC (0xFF40) y control del LCD</li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Windows y m贸dulos compilados:</strong> Windows bloquea archivos `.pyd` cuando est谩n en uso por Python. Para actualizar el m贸dulo, es necesario cerrar todas las instancias de Python o renombrar el archivo antes de recompilar.</li>
                        <li><strong>Diagn贸stico de c贸digo nuevo:</strong> A帽adir un log temporal que se imprime la primera vez que se ejecuta un m茅todo es una forma efectiva de confirmar que el binario se actualiz贸 correctamente.</li>
                        <li><strong>LCDC y estado del LCD:</strong> El registro LCDC (0xFF40) controla si el LCD est谩 encendido (bit 7). Si el LCD est谩 apagado, la PPU se detiene y LY se mantiene en 0.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Comportamiento en otros sistemas:</strong> 驴Linux y macOS tienen el mismo problema con archivos `.so` en uso?</li>
                        <li><strong>Estrategia de build:</strong> 驴Deber铆amos a帽adir un script de build que autom谩ticamente cierre procesos de Python y renombre archivos antes de compilar?</li>
                    </ul>

                    <h3>Hip贸tesis y Suposiciones</h3>
                    <p>
                        Asumimos que el problema es que Windows no permite sobrescribir archivos `.pyd` en uso. Si el problema persiste despu茅s de seguir estos pasos, puede haber otro problema (por ejemplo, el compilador no est谩 generando el archivo en la ubicaci贸n correcta).
                    </p>
                </div>
            </section>

            <!-- 8. Pr贸ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr贸ximos Pasos</h2>
                <ul>
                    <li>[ ] Verificar que el log `[PPU C++] STEP LIVE` aparece al ejecutar el emulador</li>
                    <li>[ ] Confirmar que la pantalla es blanca (sin punto rojo)</li>
                    <li>[ ] Verificar que LY avanza correctamente</li>
                    <li>[ ] Eliminar el log temporal despu茅s de confirmar que funciona</li>
                    <li>[ ] Considerar a帽adir un script de build automatizado para Windows</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia c贸digo de otros emuladores. Basado 煤nicamente en documentaci贸n t茅cnica.</p>
        </footer>
    </div>
</body>
</html>

