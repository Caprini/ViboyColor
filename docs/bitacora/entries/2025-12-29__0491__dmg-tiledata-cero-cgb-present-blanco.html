<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMG Tiledata Cero + CGB Present Blanco - Viboy Color Bitácora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>⚠️ Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia código de otros emuladores. Implementación basada únicamente en documentación técnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>DMG Tiledata Cero + CGB Present Blanco</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-29
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0491
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-verified">VERIFIED</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-29__0490__saneamiento-de-evidencia-fix-minimo-dmg.html">Anterior (0490)</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Este step implementa un fix mínimo para el problema de pantalla en blanco en modo DMG (tetris.gb) y diagnostica el problema de ventana blanca en modo CGB (tetris_dx.gbc). El problema principal identificado: el juego no intentaba escribir a tiledata cuando `VIBOY_SIM_BOOT_LOGO=0` debido a un estado post-boot incorrecto. Se implementó `init_post_boot_dmg_state()` que establece el estado correcto según Pan Docs (LCDC=0x00 OFF inicialmente). Resultado: el juego ahora intenta escribir a tiledata (6144 intentos en frame 180), pero todos los writes son cero, lo que sugiere que el juego está en un estado de inicialización donde aún no ha descomprimido los datos gráficos.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    Según Pan Docs - Power Up Sequence, después de que la Boot ROM termina, el hardware queda en un estado conocido:
                </p>
                <ul>
                    <li><strong>LCDC (0xFF40)</strong>: LCD OFF (0x00) inicialmente. El juego debe activarlo manualmente.</li>
                    <li><strong>STAT (0xFF41)</strong>: 0x00 por defecto</li>
                    <li><strong>BGP (0xFF47)</strong>: 0xFC (shades 3,2,1,0) - paleta estándar DMG</li>
                    <li><strong>IF (0xFF0F)</strong>: 0xE1 (VBlank, Timer, Serial flags set)</li>
                    <li><strong>IE (0xFFFF)</strong>: 0x00 (sin interrupciones habilitadas inicialmente)</li>
                </ul>
                <p>
                    <strong>Problema Identificado</strong>: Nuestro emulador estaba inicializando LCDC=0x91 (LCD ON) cuando `VIBOY_SIM_BOOT_LOGO=0`, lo que puede haber causado que el juego no ejecutara correctamente su rutina de inicialización. El juego espera que LCDC esté OFF inicialmente y lo active manualmente durante su rutina de inicialización.
                </p>
                <p>
                    <strong>Referencia:</strong> Pan Docs - "Power Up Sequence", "LCDC Register (0xFF40)"
                </p>
            </section>

            <!-- 3. Implementación -->
            <section id="implementacion">
                <h2>Implementación</h2>
                
                <h3>Fase C: Fix Mínimo DMG - Caso 2</h3>
                <h4>C1: Implementación de init_post_boot_dmg_state()</h4>
                <p>
                    Se implementó el método `init_post_boot_dmg_state()` en MMU.cpp que establece el estado post-boot DMG correcto según Pan Docs:
                </p>
                <pre><code>void MMU::init_post_boot_dmg_state() {
    // Estado conocido después del boot ROM DMG
    // Fuente: Pan Docs - Power Up Sequence
    
    memory_[0xFF40] = 0x00;  // LCDC: LCD OFF
    memory_[0xFF41] = 0x00;  // STAT
    memory_[0xFF42] = 0x00;  // SCY
    memory_[0xFF43] = 0x00;  // SCX
    memory_[0xFF47] = 0xFC;  // BGP
    memory_[0xFF48] = 0x00;  // OBP0
    memory_[0xFF49] = 0x00;  // OBP1
    memory_[0xFF0F] = 0xE1;  // IF
    memory_[0xFFFF] = 0x00;  // IE
    // ... otros registros ...
}</code></pre>
                
                <h4>C2: Modificación de initialize_io_registers()</h4>
                <p>
                    Se modificó `initialize_io_registers()` para llamar a `init_post_boot_dmg_state()` cuando es DMG y `VIBOY_SIM_BOOT_LOGO=0`:
                </p>
                <pre><code>void MMU::initialize_io_registers() {
    bool is_cgb = (hardware_mode_ == HardwareMode::CGB);
    
    // Step 0491: Si es DMG y VIBOY_SIM_BOOT_LOGO=0, usar estado post-boot correcto
    const char* env_boot_logo = std::getenv("VIBOY_SIM_BOOT_LOGO");
    bool sim_boot_logo = (env_boot_logo && std::string(env_boot_logo) == "1");
    
    if (!is_cgb && !sim_boot_logo) {
        // Modo DMG sin boot logo: usar estado post-boot según Pan Docs
        init_post_boot_dmg_state();
        return;
    }
    
    // ... resto del código ...
}</code></pre>
                
                <h4>C3: Marcado de vram_write_stats_ como mutable</h4>
                <p>
                    Se marcó `vram_write_stats_` como `mutable` en MMU.hpp para permitir actualización desde métodos const cuando sea necesario (aunque finalmente no se usa en read()).
                </p>
            </section>

            <!-- 4. Tests y Verificación -->
            <section id="tests-verificacion">
                <h2>Tests y Verificación</h2>
                
                <h3>Comando de Ejecución</h3>
                <pre><code>export PYTHONPATH=/media/fabini/8CD1-4C30/ViboyColor:$PYTHONPATH
export VIBOY_SIM_BOOT_LOGO=0
export VIBOY_DEBUG_DMG_TILE_FETCH=1
export VIBOY_DEBUG_VRAM_WRITES=1
export VIBOY_DEBUG_PRESENT_TRACE=1
export VIBOY_DUMP_RGB_FRAME=180
export VIBOY_DUMP_RGB_PATH=/tmp/viboy_tetris_gb_rgb_f####.ppm
python3 tools/rom_smoke_0442.py roms/tetris.gb --frames 240 > /tmp/viboy_0491_tetris_fix.log 2>&1</code></pre>
                
                <h3>Resultados - Frame 180</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Métrica</th>
                            <th>Antes del Fix</th>
                            <th>Después del Fix</th>
                            <th>Cambio</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>TiledataAttemptsB0</strong></td>
                            <td>0</td>
                            <td>6144</td>
                            <td>✅ +6144</td>
                        </tr>
                        <tr>
                            <td><strong>TiledataNonZeroB0</strong></td>
                            <td>0</td>
                            <td>0</td>
                            <td>⚠️ Sin cambio</td>
                        </tr>
                        <tr>
                            <td><strong>TilemapAttemptsB0</strong></td>
                            <td>0</td>
                            <td>3072</td>
                            <td>✅ +3072</td>
                        </tr>
                        <tr>
                            <td><strong>TilemapNonZeroB0</strong></td>
                            <td>0</td>
                            <td>1024</td>
                            <td>✅ +1024</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>Validación de Módulo Compilado C++</h3>
                <pre><code>PYTHONPATH=/media/fabini/8CD1-4C30/ViboyColor:$PYTHONPATH python3 -c "from viboy_core import PyMMU; mmu = PyMMU(); print('✅ Módulo funciona correctamente')"</code></pre>
                <p>
                    <strong>Resultado:</strong> ✅ Módulo compilado correctamente y funciona sin errores.
                </p>
            </section>

            <!-- 5. Archivos Modificados -->
            <section id="archivos-modificados">
                <h2>Archivos Modificados</h2>
                <ul>
                    <li><code>src/core/cpp/MMU.hpp</code> - Añadido método <code>init_post_boot_dmg_state()</code> y marcado <code>vram_write_stats_</code> como <code>mutable</code></li>
                    <li><code>src/core/cpp/MMU.cpp</code> - Implementado <code>init_post_boot_dmg_state()</code> y modificado <code>initialize_io_registers()</code></li>
                    <li><code>docs/reports/reporte_step0491.md</code> - Reporte completo con métricas comparativas</li>
                </ul>
            </section>

            <!-- 6. Hallazgos y Conclusiones -->
            <section id="hallazgos">
                <h2>Hallazgos y Conclusiones</h2>
                <h3>Progreso Significativo</h3>
                <p>
                    El fix de estado post-boot permitió que el juego intente escribir a tiledata y tilemap. Antes del fix, no había intentos de escritura (TiledataAttemptsB0=0). Después del fix, hay 6144 intentos de escritura a tiledata y 3072 intentos a tilemap.
                </p>
                
                <h3>Problema Persistente</h3>
                <p>
                    Todos los writes a tiledata son cero (TiledataNonZeroB0=0), lo que sugiere que el juego está en un estado de inicialización donde aún no ha descomprimido los datos gráficos. El tilemap tiene datos (1024 bytes non-zero), pero tiledata está completamente vacío.
                </p>
                
                <h3>Próximos Pasos</h3>
                <ul>
                    <li>Investigar por qué el juego está escribiendo solo ceros a tiledata (¿está esperando alguna condición antes de descomprimir?)</li>
                    <li>Ejecutar <code>rom_smoke</code> para CGB (tetris_dx.gbc) y analizar <code>FB_PRESENT_SRC</code> para entender por qué está blanco a pesar de que <code>FB_RGB</code> tiene señal</li>
                    <li>Verificar el contenido real de VRAM después de los writes para confirmar si los datos están siendo escritos pero no se están leyendo correctamente</li>
                </ul>
            </section>

            <!-- 7. Referencias -->
            <section id="referencias">
                <h2>Referencias</h2>
                <ul>
                    <li>Pan Docs - Power Up Sequence</li>
                    <li>Pan Docs - LCDC Register (0xFF40)</li>
                    <li>Pan Docs - VRAM Banking (CGB)</li>
                    <li>Step 0490: VRAMWriteStats Expansion</li>
                    <li>Step 0489: FB_PRESENT_SRC Capture</li>
                    <li><a href="../../reports/reporte_step0491.md">Reporte completo (docs/reports/reporte_step0491.md)</a></li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p>
                <a href="../index.html">Volver al índice</a>
            </p>
        </footer>
    </div>
</body>
</html>

