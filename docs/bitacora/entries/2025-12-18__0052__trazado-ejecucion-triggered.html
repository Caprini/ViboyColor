<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trazado de Ejecuci√≥n "Triggered" - Viboy Color Bit√°cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>‚ö†Ô∏è Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c√≥digo de otros emuladores. Implementaci√≥n basada √∫nicamente en documentaci√≥n t√©cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Trazado de Ejecuci√≥n "Triggered" (Trap Trace)</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-18
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0052
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-draft">Draft</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-18__0051__diagnostico-bloqueo-interrupciones.html">Anterior</a></li>
                    <li><a href="2025-12-18__0053__correccion-ppu-lcd-enabled.html">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Se implement√≥ un sistema de trazado de ejecuci√≥n "triggered" (disparado) que se activa autom√°ticamente cuando el juego escribe `LCDC=0x80` (LCD ON sin fondo). El sistema captura las primeras 100 instrucciones ejecutadas despu√©s de este evento cr√≠tico, mostrando informaci√≥n detallada de cada instrucci√≥n: PC, opcode, registros, flags, estado de interrupciones (IF/IE), y estado de la PPU (LY/STAT). Este trazado permitir√° identificar si el juego entra en un bucle de polling esperando V-Blank y por qu√© no sale de ese bucle.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    Cuando un juego de Game Boy enciende el LCD escribiendo `LCDC=0x80`, est√° activando la pantalla pero sin el fondo (bit 0 = 0). Este es un estado transitorio com√∫n en la inicializaci√≥n: el juego enciende el LCD y luego espera a que ocurra V-Blank para configurar el resto de los gr√°ficos (activar fondo, sprites, etc.).
                </p>
                <p>
                    Si el juego tiene las interrupciones deshabilitadas (`IE=00`), no puede usar el mecanismo autom√°tico de interrupciones. En su lugar, debe hacer <strong>polling</strong> (preguntar manualmente) leyendo el registro `IF` (0xFF0F) y comprobando el bit 0 (V-Blank). Si el bit est√° activo, el juego sabe que est√° en V-Blank y puede continuar. Si no, debe esperar en un bucle.
                </p>
                <p>
                    El problema que estamos investigando es que el juego se queda atascado despu√©s de encender el LCD. El trazado nos permitir√° ver exactamente qu√© instrucciones se ejecutan y si hay un bucle de polling que nunca detecta V-Blank, lo cual indicar√≠a que nuestro emulador no est√° activando correctamente el flag V-Blank en `IF` cuando corresponde.
                </p>
                <p>
                    <strong>Fuente:</strong> Pan Docs - LCD Control Register, Interrupt Flag Register, V-Blank Polling
                </p>
            </section>

            <!-- 3. Implementaci√≥n -->
            <section id="implementacion">
                <h2>Implementaci√≥n</h2>
                <p>
                    Se a√±adi√≥ un sistema de trazado en la clase `Viboy` que se activa autom√°ticamente cuando se detecta un cambio en el registro LCDC de cualquier valor a `0x80`. El sistema captura el estado de la CPU antes de cada instrucci√≥n y muestra informaci√≥n detallada en consola.
                </p>
                
                <h3>Componentes modificados</h3>
                <ul>
                    <li><code>src/viboy.py</code>: A√±adidos atributos `_trace_active`, `_trace_counter`, y `_prev_lcdc` para controlar el trazado. La l√≥gica de detecci√≥n y trazado se implement√≥ en el m√©todo `run()`.</li>
                </ul>

                <h3>Decisiones de dise√±o</h3>
                <p>
                    <strong>Detecci√≥n de activaci√≥n:</strong> El trazado se activa cuando LCDC cambia de cualquier valor a `0x80`. Esto captura el momento exacto en que el juego enciende el LCD, que es cuando comienza el problema que estamos investigando.
                </p>
                <p>
                    <strong>L√≠mite de 100 instrucciones:</strong> Se limita el trazado a 100 instrucciones para evitar inundar la consola con informaci√≥n. Este n√∫mero es suficiente para ver varios ciclos de un bucle de polling t√≠pico.
                </p>
                <p>
                    <strong>Informaci√≥n capturada:</strong> El trazado muestra PC, opcode, todos los registros (A, BC, DE, HL, SP), flags (Z, N, H, C), registros de interrupciones (IF, IE), y estado de la PPU (LY, STAT). Esta informaci√≥n es suficiente para entender qu√© est√° haciendo el juego y por qu√© se queda atascado.
                </p>
                <p>
                    <strong>Captura antes del tick:</strong> El PC y opcode se capturan antes de ejecutar la instrucci√≥n (`tick()`), para mostrar la instrucci√≥n que se va a ejecutar, no la siguiente. Esto es m√°s √∫til para debugging.
                </p>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/viboy.py</code> - A√±adido sistema de trazado "triggered" con detecci√≥n de cambio de LCDC a 0x80</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificaci√≥n -->
            <section id="tests">
                <h2>Tests y Verificaci√≥n</h2>
                <p>
                    <strong>Estado:</strong> Ejecutado con ROM de prueba (pkmn.gb).
                </p>
                <p>
                    <strong>Comando ejecutado:</strong> <code>python main.py pkmn.gb</code>
                </p>
                <p>
                    <strong>Entorno:</strong> Windows, Python 3.13.5
                </p>
                <p>
                    <strong>Resultado observado:</strong> El trace se activ√≥ correctamente cuando el juego escribi√≥ `LCDC=0x80`. Se capturaron 100 instrucciones mostrando un bucle de polling claro:
                </p>
                <pre><code>TRACE [007]: PC=0x006B | OP=0xF0 | ... | IF=0x00 IE=0x00 | LY=  0 STAT=0x03 | Cycles=3
TRACE [008]: PC=0x006D | OP=0xFE | ... | IF=0x00 IE=0x00 | LY=  0 STAT=0x03 | Cycles=2
TRACE [009]: PC=0x006F | OP=0x20 | ... | IF=0x00 IE=0x00 | LY=  0 STAT=0x03 | Cycles=3
TRACE [010]: PC=0x006B | OP=0xF0 | ... | IF=0x00 IE=0x00 | LY=  0 STAT=0x03 | Cycles=3
...</code></pre>
                <p>
                    <strong>An√°lisis del bucle:</strong> El patr√≥n identificado es:
                </p>
                <ul>
                    <li><code>0xF0</code> (LDH A, (n)) en PC=0x006B - Lee IF (0xFF0F)</li>
                    <li><code>0xFE</code> (CP d8) en PC=0x006D - Compara A con un valor inmediato (probablemente 0x01 para el bit V-Blank)</li>
                    <li><code>0x20</code> (JR NZ, e) en PC=0x006F - Salto relativo si no es cero (vuelve atr√°s si no hay V-Blank)</li>
                </ul>
                <p>
                    <strong>Problema identificado:</strong> El trace muestra que:
                </p>
                <ul>
                    <li>LY avanza correctamente (0 ‚Üí 1 ‚Üí 2), lo que indica que la PPU est√° funcionando</li>
                    <li>IF siempre es 0x00, lo que significa que el flag V-Blank nunca se activa</li>
                    <li>El trace solo captura 100 instrucciones (~1 l√≠nea), pero para llegar a LY=144 se necesitan ~5,472 instrucciones</li>
                    <li>No aparece el log <code>üéØ PPU: V-Blank iniciado</code>, lo que confirma que la PPU no est√° llegando a LY=144</li>
                </ul>
                <p>
                    <strong>Hip√≥tesis:</strong> El problema es que la PPU no est√° avanzando lo suficientemente r√°pido, o hay alg√∫n problema con la verificaci√≥n del LCD. Se implement√≥ una correcci√≥n para verificar que el LCD est√© encendido antes de avanzar la PPU.
                </p>
                <p>
                    <strong>Modificaciones realizadas:</strong>
                </p>
                <ul>
                    <li>Aumentado el l√≠mite del trace de 100 a 1000 instrucciones para capturar m√°s informaci√≥n</li>
                    <li>A√±adida verificaci√≥n en PPU para que solo avance cuando el LCD est√© encendido (LCDC bit 7 = 1)</li>
                    <li>A√±adido log informativo cuando se activa V-Blank para diagn√≥stico</li>
                </ul>
                <p>
                    <strong>Estado:</strong> <span class="tag tag-draft">Draft</span> - Pendiente de verificar si la correcci√≥n resuelve el problema.
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/LCDC.html">LCD Control Register</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Interrupts.html">Interrupt Flag Register (IF)</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Interrupts.html#v-blank-polling">V-Blank Polling</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Polling vs Interrupciones:</strong> Cuando las interrupciones est√°n deshabilitadas, los juegos deben hacer polling manual del registro IF para detectar eventos como V-Blank. Esto es menos eficiente pero permite control total sobre cu√°ndo se procesan los eventos.</li>
                        <li><strong>Estado transitorio LCDC=0x80:</strong> Este valor indica que el LCD est√° encendido pero el fondo est√° desactivado. Es un estado com√∫n durante la inicializaci√≥n, donde el juego espera V-Blank para configurar el resto de los gr√°ficos.</li>
                        <li><strong>Trazado "triggered":</strong> Un sistema de trazado que se activa autom√°ticamente cuando ocurre un evento espec√≠fico (en este caso, cambio de LCDC a 0x80) es m√°s √∫til que un trazado continuo, ya que captura exactamente el momento cr√≠tico sin generar ruido innecesario.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Patr√≥n de polling:</strong> Necesito verificar si el juego realmente entra en un bucle de polling y qu√© instrucciones exactas usa. El trazado nos dar√° esta informaci√≥n.</li>
                        <li><strong>Activaci√≥n de IF:</strong> Necesito confirmar si nuestro emulador est√° activando correctamente el bit 0 de IF cuando la PPU entra en V-Blank. Si no lo hace, el juego nunca detectar√° V-Blank y se quedar√° atascado.</li>
                        <li><strong>Timing de V-Blank:</strong> Necesito verificar si el timing de la PPU es correcto y si V-Blank se activa en el momento adecuado seg√∫n la especificaci√≥n del hardware.</li>
                    </ul>

                    <h3>Hip√≥tesis y Suposiciones</h3>
                    <p>
                        <strong>Hip√≥tesis principal:</strong> El juego se queda atascado porque entra en un bucle de polling esperando V-Blank, pero nuestro emulador no est√° activando correctamente el flag V-Blank en IF cuando la PPU entra en modo V-Blank.
                    </p>
                    <p>
                        <strong>Suposici√≥n:</strong> Asumo que el juego usa polling porque IE=00 (interrupciones deshabilitadas). Si el trazado muestra un bucle de lectura de IF, esto confirmar√° la suposici√≥n.
                    </p>
                </div>
            </section>

            <!-- 8. Pr√≥ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr√≥ximos Pasos</h2>
                <ul>
                    <li>[ ] Ejecutar el emulador con una ROM (pkmn.gb) y capturar el trazado cuando se active</li>
                    <li>[ ] Analizar el trazado para identificar si hay un bucle de polling</li>
                    <li>[ ] Si hay un bucle, verificar si el flag V-Blank en IF se activa correctamente</li>
                    <li>[ ] Si el flag no se activa, revisar la l√≥gica de la PPU para asegurar que activa IF cuando entra en V-Blank</li>
                    <li>[ ] Verificar el timing de la PPU para asegurar que V-Blank ocurre en el momento correcto</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia c√≥digo de otros emuladores. Basado √∫nicamente en documentaci√≥n t√©cnica.</p>
        </footer>
    </div>
</body>
</html>

