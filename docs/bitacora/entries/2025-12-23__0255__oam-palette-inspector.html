<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 0255 - Inspector OAM y Paletas - Viboy Color Bitácora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>⚠️ Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia código de otros emuladores. Implementación basada únicamente en documentación técnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Step 0255 - Inspector OAM y Paletas</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-23
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0255
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-draft">Draft</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-23__0254__sprite-rendering-ppu-phase-e.html">Anterior (0254)</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Este Step extiende el monitor GPS (Step 0240) en <code>src/viboy.py</code> para incluir
                    inspección en tiempo real de los registros de paleta (BGP, OBP0, OBP1) y los primeros
                    sprites de la OAM (Object Attribute Memory). El objetivo es diagnosticar por qué la
                    pantalla aparece verde/blanca cuando debería mostrar sprites, verificando si el problema
                    está en los datos (OAM vacía o DMA no funcionando) o en el renderizado (paletas incorrectas).
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    En la Game Boy, los sprites (objetos) se almacenan en la OAM (Object Attribute Memory),
                    ubicada en el rango <code>0xFE00-0xFE9F</code> (160 bytes = 40 sprites × 4 bytes).
                    Cada sprite ocupa 4 bytes consecutivos:
                </p>
                <ul>
                    <li><strong>Byte 0 (Y)</strong>: Posición vertical (0-255, pero Y=0 o Y≥160 oculta el sprite)</li>
                    <li><strong>Byte 1 (X)</strong>: Posición horizontal (0-255, pero X=0 o X≥168 oculta el sprite)</li>
                    <li><strong>Byte 2 (Tile)</strong>: Índice del tile en VRAM (0-255)</li>
                    <li><strong>Byte 3 (Attributes)</strong>: Atributos (paleta, flip X/Y, prioridad, etc.)</li>
                </ul>
                <p>
                    Los registros de paleta controlan cómo se traducen los colores de los tiles:
                </p>
                <ul>
                    <li><strong>BGP (0xFF47)</strong>: Paleta del Background (4 colores: 00, 01, 10, 11)</li>
                    <li><strong>OBP0 (0xFF48)</strong>: Paleta de Sprites (canal 0, colores 1-3; color 0 es transparente)</li>
                    <li><strong>OBP1 (0xFF49)</strong>: Paleta de Sprites (canal 1, colores 1-3; color 0 es transparente)</li>
                </ul>
                <p>
                    <strong>Problema crítico:</strong> Si <code>OBP0</code> o <code>OBP1</code> están en <code>0x00</code>
                    o <code>0xFF</code> (todos blancos o todos transparentes), los sprites serán invisibles incluso
                    si están correctamente renderizados. Si la OAM está vacía (todos ceros), la DMA no está funcionando
                    o el juego no ha inicializado los sprites aún.
                </p>
                <p>
                    <strong>Fuente:</strong> Pan Docs - OAM (Object Attribute Memory), Sprite Attributes, Palette Registers
                </p>
            </section>

            <!-- 3. Implementación -->
            <section id="implementacion">
                <h2>Implementación</h2>
                <p>
                    Se modificó el bloque del monitor GPS en <code>src/viboy.py</code> (líneas 944-976) para añadir
                    lectura de registros de paleta y los primeros 2 sprites de la OAM. La inspección se ejecuta cada
                    segundo (60 frames) junto con el reporte GPS estándar.
                </p>
                
                <h3>Componentes modificados</h3>
                <ul>
                    <li><code>src/viboy.py</code>: Extendido el bloque GPS (Step 0240) con inspección de OAM y paletas</li>
                </ul>

                <h3>Lógica de inspección</h3>
                <p>
                    El código lee:
                </p>
                <ul>
                    <li><strong>Paletas:</strong> <code>0xFF47</code> (BGP), <code>0xFF48</code> (OBP0), <code>0xFF49</code> (OBP1)</li>
                    <li><strong>Sprite 0:</strong> <code>0xFE00-0xFE03</code> (Y, X, Tile, Attributes)</li>
                    <li><strong>Sprite 1:</strong> <code>0xFE04-0xFE07</code> (Y, X, Tile, Attributes)</li>
                </ul>
                <p>
                    Los valores se registran usando <code>logger.info()</code> con formato hexadecimal para facilitar
                    el diagnóstico. El formato es:
                </p>
                <pre><code>[VIDEO] BGP:XX OBP0:XX OBP1:XX | LCDC:XX
[SPRITE 0] Y:XX X:XX T:XX A:XX
[SPRITE 1] Y:XX X:XX T:XX A:XX</code></pre>
                <p>
                    <strong>Escenarios de diagnóstico:</strong>
                </p>
                <ul>
                    <li><strong>OAM vacía (Y:00 X:00 T:00):</strong> La DMA no está copiando datos o la memoria se borra</li>
                    <li><strong>OAM con datos válidos (Y:10 X:08 T:5A):</strong> Los sprites están presentes. Si no se ven, el problema está en el renderizado C++ o en las paletas</li>
                    <li><strong>Paletas en 0x00 o 0xFF:</strong> Los sprites serán invisibles (blancos o transparentes)</li>
                </ul>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/viboy.py</code> - Extendido el monitor GPS con inspección de OAM y paletas (Step 0255)</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificación -->
            <section id="tests">
                <h2>Tests y Verificación</h2>
                <p>
                    Este Step no requiere tests unitarios, ya que es una herramienta de diagnóstico en tiempo real.
                    La validación se realiza ejecutando el emulador y observando los logs:
                </p>
                <ul>
                    <li><strong>Comando:</strong> <code>python main.py roms/pkmn.gb</code> (o cualquier ROM con sprites)</li>
                    <li><strong>Observación:</strong> Los logs <code>[VIDEO]</code> y <code>[SPRITE]</code> aparecen cada segundo en la consola</li>
                    <li><strong>Validación:</strong> Verificar que los valores de OAM y paletas sean coherentes con el estado del juego</li>
                </ul>
                <p>
                    <strong>Nota:</strong> Este Step no modifica el núcleo C++, solo añade instrumentación en Python
                    para diagnóstico. No se requiere recompilación de C++.
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/OAM.html">OAM (Object Attribute Memory)</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/LCDC.html">LCDC (LCD Control Register)</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/Palettes.html">Palette Registers (BGP, OBP0, OBP1)</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>OAM Structure:</strong> Cada sprite ocupa 4 bytes consecutivos (Y, X, Tile, Attributes) en el rango 0xFE00-0xFE9F</li>
                        <li><strong>Palette Registers:</strong> BGP controla el fondo, OBP0/OBP1 controlan los sprites. Si están en 0x00 o 0xFF, los sprites serán invisibles</li>
                        <li><strong>Diagnóstico:</strong> La inspección de OAM y paletas permite distinguir entre problemas de datos (OAM vacía) y problemas de renderizado (paletas incorrectas)</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>DMA Timing:</strong> Verificar que la DMA se ejecuta frecuentemente y no se borra la OAM entre frames</li>
                        <li><strong>Sprite Visibility:</strong> Confirmar que los sprites con Y=0 o X=0 se ocultan correctamente en el renderizado</li>
                        <li><strong>Palette Mapping:</strong> Verificar que el renderizado C++ respeta correctamente los valores de OBP0/OBP1</li>
                    </ul>

                    <h3>Hipótesis y Suposiciones</h3>
                    <p>
                        <strong>Hipótesis principal:</strong> Si la pantalla aparece verde/blanca con sprites implementados,
                        el problema más probable es que las paletas OBP0/OBP1 estén en 0x00 (todos transparentes) o que
                        la OAM esté vacía (DMA no funcionando o juego aún inicializando).
                    </p>
                    <p>
                        Esta herramienta de diagnóstico permitirá confirmar o refutar esta hipótesis observando los valores
                        reales en tiempo de ejecución.
                    </p>
                </div>
            </section>

            <!-- 8. Próximos Pasos -->
            <section id="proximos-pasos">
                <h2>Próximos Pasos</h2>
                <ul>
                    <li>[ ] Ejecutar el emulador con una ROM (Pokémon Red, Mario) y observar los logs de OAM y paletas</li>
                    <li>[ ] Analizar los valores reportados para determinar si el problema es de datos (OAM vacía) o renderizado (paletas incorrectas)</li>
                    <li>[ ] Si OAM está vacía: Investigar la DMA y verificar que se ejecuta frecuentemente</li>
                    <li>[ ] Si OAM tiene datos pero sprites invisibles: Verificar el renderizado C++ y el mapeo de paletas</li>
                    <li>[ ] Corregir el problema identificado y validar que los sprites se muestran correctamente</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia código de otros emuladores. Basado únicamente en documentación técnica.</p>
        </footer>
    </div>
</body>
</html>

