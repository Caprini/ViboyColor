<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modo Rayos X: Renderizado Forzado - Viboy Color Bit√°cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>‚ö†Ô∏è Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c√≥digo de otros emuladores. Implementaci√≥n basada √∫nicamente en documentaci√≥n t√©cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Modo Rayos X: Renderizado Forzado</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-18
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0059
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-draft">Draft</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-18__0058__restaurar-hack-renderizado-lcdc.html">Anterior</a></li>
                    <li><a href="2025-12-18__0060__verificacion-bank-switching-mbc1.html">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Se implement√≥ el "Modo Rayos X", una herramienta de diagn√≥stico que fuerza el renderizado
                    de la VRAM incluso cuando el LCD est√° apagado (LCDC bit 7=0). Esto permite visualizar qu√©
                    contenido hay en la VRAM durante los momentos en que el juego apaga r√°pidamente el LCD,
                    lo cual es especialmente √∫til para diagnosticar problemas de arranque en juegos como
                    Pok√©mon Red que encienden y apagan el LCD en milisegundos.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    En la Game Boy real, cuando el Bit 7 del registro LCDC est√° en 0, el LCD est√° completamente
                    desactivado y no se renderiza nada. El hardware de la PPU (Picture Processing Unit) simplemente
                    no genera se√±ales de v√≠deo, y la pantalla muestra un estado en blanco o apagado.
                </p>
                <p>
                    Durante el arranque de muchos juegos, especialmente los que tienen secuencias de inicializaci√≥n
                    complejas, el juego puede encender el LCD brevemente (LCDC=0x80), verificar el estado, y luego
                    apagarlo de nuevo (LCDC=0x00) para realizar configuraciones adicionales antes de mostrar la
                    pantalla final. Este comportamiento es normal y permite al juego configurar la VRAM, paletas,
                    sprites y otros componentes sin que el usuario vea contenido incompleto o corrupto.
                </p>
                <p>
                    Sin embargo, cuando estamos depurando un emulador, puede ser muy √∫til ver qu√© hay en la VRAM
                    incluso cuando el LCD est√° apagado. Esto nos permite entender:
                </p>
                <ul>
                    <li>Si la VRAM se est√° cargando correctamente (DMA, copias manuales)</li>
                    <li>Si los tiles est√°n en las direcciones esperadas</li>
                    <li>Si el tilemap tiene datos v√°lidos</li>
                    <li>Qu√© est√° viendo el juego (o qu√© intentar√≠a ver) cuando enciende el LCD</li>
                </ul>
                <p>
                    El "Modo Rayos X" es una herramienta de diagn√≥stico que NO representa el comportamiento real
                    del hardware. Es puramente educativa y permite "ver a trav√©s" del estado del LCD para inspeccionar
                    el contenido de la VRAM en cualquier momento.
                </p>
                <p>
                    <strong>Fuente:</strong> Pan Docs - LCD Control Register, PPU States
                </p>
            </section>

            <!-- 3. Implementaci√≥n -->
            <section id="implementacion">
                <h2>Implementaci√≥n</h2>
                <p>
                    Se modific√≥ la funci√≥n <code>render_frame()</code> en <code>src/gpu/renderer.py</code> para
                    implementar el Modo Rayos X. En lugar de retornar inmediatamente cuando el LCD est√° apagado,
                    ahora forzamos una configuraci√≥n de LCDC que permite renderizar el contenido de la VRAM.
                </p>
                
                <h3>Cambio realizado</h3>
                <p>
                    Se elimin√≥ el <code>return</code> temprano cuando <code>lcdc_bit7 == 0</code> y se reemplaz√≥
                    con l√≥gica que fuerza un valor de LCDC apropiado para renderizado. Espec√≠ficamente:
                </p>
                <ul>
                    <li><strong>LCDC forzado: 0x91</strong>
                        <ul>
                            <li>Bit 7 = 1: LCD ON (forzado para permitir renderizado)</li>
                            <li>Bit 4 = 1: Tile Data desde 0x8000 (unsigned addressing)</li>
                            <li>Bit 3 = 0: Tile Map desde 0x9800</li>
                            <li>Bit 0 = 1: BG Display ON</li>
                        </ul>
                    </li>
                    <li>Se establece <code>lcdc_bit7 = True</code> para que el resto del c√≥digo de renderizado
                        funcione normalmente</li>
                    <li>Se registra un mensaje de debug indicando que se est√° usando el Modo Rayos X</li>
                </ul>

                <h3>Decisiones de dise√±o</h3>
                <p>
                    Se eligi√≥ LCDC=0x91 como configuraci√≥n forzada porque:
                </p>
                <ul>
                    <li>Es una configuraci√≥n com√∫n que muchos juegos usan durante la inicializaci√≥n</li>
                    <li>Permite renderizar tanto el fondo (Background) como usar tiles desde 0x8000</li>
                    <li>Es una configuraci√≥n "razonable" que probablemente represente lo que el juego intentar√≠a
                        ver si el LCD estuviera encendido</li>
                </ul>
                <p>
                    <strong>Nota importante:</strong> Esta es una herramienta temporal de diagn√≥stico. No representa
                    el comportamiento real del hardware y solo debe usarse para debugging. En un emulador completo,
                    cuando el LCD est√° apagado, no deber√≠a renderizarse nada.
                </p>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/gpu/renderer.py</code> - Modificaci√≥n en <code>render_frame()</code> para implementar Modo Rayos X</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificaci√≥n -->
            <section id="tests">
                <h2>Tests y Verificaci√≥n</h2>
                <p>
                    Esta implementaci√≥n es una herramienta de diagn√≥stico y no requiere tests unitarios formales,
                    ya que no representa comportamiento real del hardware. Se valid√≥ ejecutando el emulador con Pok√©mon Red.
                </p>
                
                <h3>Ejecuci√≥n de prueba con Pok√©mon Red</h3>
                <p>
                    <strong>Comando ejecutado:</strong> <code>python main.py pkmn.gb</code>
                </p>
                <p>
                    <strong>Entorno:</strong> Windows 10, Python 3.13.5, pygame-ce 2.5.6
                </p>
                <p>
                    <strong>ROM:</strong> Pok√©mon Red (ROM aportada por el usuario, no distribuida)
                </p>
                
                <h4>Salida de consola:</h4>
                <pre><code>pygame-ce 2.5.6 (SDL 2.32.10, Python 3.13.5)
Viboy Color - Sistema Iniciado
==================================================

üì¶ Cartucho cargado:
   T√≠tulo: POKEMON RED
   Tipo: 0x13
   ROM: 1024 KB
   RAM: 32 KB
   Tama√±o total: 1048576 bytes

üñ•Ô∏è  CPU inicializada:
   PC = 0x0100
   SP = 0xFFFE

‚úÖ Sistema listo para ejecutar
   Presiona Ctrl+C para detener

WARNING: üî• HACK: Forzando BGP 0x00 -> 0xE4 para visibilidad (el juego intent√≥ escribir paleta blanca, forzamos paleta est√°ndar)</code></pre>

                <h4>Resultado visual:</h4>
                <p>
                    <strong>Pantalla observada:</strong> Pantalla completamente blanca
                </p>
                <p>
                    <strong>Interpretaci√≥n:</strong> La pantalla blanca indica que:
                </p>
                <ul>
                    <li>El Modo Rayos X est√° funcionando correctamente (est√° forzando el renderizado cuando el LCD est√° apagado)</li>
                    <li>La VRAM est√° vac√≠a o contiene solo ceros (todos los tiles tienen √≠ndice de color 0)</li>
                    <li>Con la paleta est√°ndar (BGP=0xE4), el color √≠ndice 0 corresponde a blanco, por lo que una VRAM vac√≠a se renderiza como pantalla blanca</li>
                    <li>El hack de BGP est√° activo (se muestra el warning), pero no ayuda porque no hay datos en VRAM para renderizar</li>
                </ul>

                <h4>Conclusiones del diagn√≥stico:</h4>
                <p>
                    <strong>Estado:</strong> <span class="tag tag-draft">Draft</span> - Diagn√≥stico completo, pendiente de implementar soluci√≥n
                </p>
                <p>
                    El hecho de ver pantalla blanca con Modo Rayos X activo revela que el problema no es solo el timing
                    de encendido/apagado del LCD, sino que la VRAM nunca se est√° cargando con datos. Esto sugiere que:
                </p>
                <ul>
                    <li><strong>Problema principal:</strong> La VRAM no est√° siendo poblada con tiles/logos durante la inicializaci√≥n</li>
                    <li><strong>Posibles causas:</strong>
                        <ul>
                            <li>El DMA (Direct Memory Access) no est√° funcionando correctamente</li>
                            <li>Las copias manuales de datos a VRAM no se est√°n ejecutando</li>
                            <li>El c√≥digo de inicializaci√≥n del juego no se est√° ejecutando completamente</li>
                            <li>Hay un bloqueo o error en la CPU antes de que el juego pueda cargar los gr√°ficos</li>
                        </ul>
                    </li>
                </ul>
                <p>
                    <strong>Pr√≥ximo paso de diagn√≥stico:</strong> Verificar si el c√≥digo del juego est√° ejecutando las
                    instrucciones que copian datos a VRAM. Esto puede requerir logging de escrituras a VRAM o ejecuci√≥n
                    paso a paso para ver d√≥nde se detiene la inicializaci√≥n.
                </p>

                <p>
                    <strong>Nota legal:</strong> La ROM de Pok√©mon Red es aportada por el usuario para pruebas locales.
                    No se distribuye ni se incluye en el repositorio.
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: LCD Control Register (<a href="https://gbdev.io/pandocs/LCDC.html">gbdev.io/pandocs/LCDC.html</a>)</li>
                    <li>Pan Docs: PPU States (<a href="https://gbdev.io/pandocs/STAT.html">gbdev.io/pandocs/STAT.html</a>)</li>
                </ul>
                <p>
                    <em>Nota: El Modo Rayos X es una herramienta de diagn√≥stico propia y no est√° documentada en
                    especificaciones oficiales, ya que no representa comportamiento real del hardware.</em>
                </p>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Control del LCD:</strong> El Bit 7 de LCDC controla si el LCD est√° encendido o apagado.
                            Cuando est√° apagado, el hardware real no genera se√±al de v√≠deo, pero la VRAM sigue siendo
                            accesible y puede contener datos v√°lidos.</li>
                        <li><strong>Timing de arranque:</strong> Muchos juegos apagan y encienden el LCD durante la
                            inicializaci√≥n para configurar el hardware sin mostrar contenido parcial al usuario.</li>
                        <li><strong>Debugging visual:</strong> Para entender qu√© est√° pasando en el emulador, puede ser
                            √∫til visualizar el contenido de la VRAM incluso cuando el LCD est√° apagado, aunque esto no
                            represente el comportamiento real del hardware.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Configuraci√≥n √≥ptima de LCDC forzado:</strong> Se eligi√≥ 0x91 como valor por defecto,
                            pero podr√≠a no ser la configuraci√≥n m√°s apropiada para todos los juegos. Podr√≠a ser √∫til
                            hacer este valor configurable o intentar "adivinar" mejor la configuraci√≥n que el juego
                            usar√≠a si el LCD estuviera encendido.</li>
                        <li><strong>Impacto en el rendimiento:</strong> Renderizar cuando el LCD est√° apagado consume
                            recursos innecesarios. En el futuro, deber√≠a ser opcional o desactivarse cuando no se necesite
                            debugging.</li>
                    </ul>

                    <h3>Hip√≥tesis y Suposiciones</h3>
                    <p>
                        <strong>Hip√≥tesis principal:</strong> Si Pok√©mon Red (u otro juego) muestra pantalla azul o
                        pantalla en blanco, podr√≠a ser porque:
                    </p>
                    <ul>
                        <li>El juego enciende el LCD brevemente pero lo apaga inmediatamente porque no recibe la
                            interrupci√≥n V-Blank esperada</li>
                        <li>La VRAM no se ha cargado correctamente (problema de DMA o copias manuales)</li>
                        <li>El timing de las interrupciones no coincide con lo que el juego espera</li>
                    </ul>
                    <p>
                        El Modo Rayos X permite visualizar la VRAM en estos momentos cr√≠ticos para determinar cu√°l
                        de estas hip√≥tesis es la correcta.
                    </p>
                </div>
            </section>

            <!-- 8. Pr√≥ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr√≥ximos Pasos</h2>
                <p>
                    Con el Modo Rayos X activo, se confirm√≥ que la VRAM est√° vac√≠a (pantalla blanca).
                    Esto cambia completamente el enfoque del diagn√≥stico:
                </p>
                <ul>
                    <li>[x] Ejecutar Pok√©mon Red con Modo Rayos X activo y observar qu√© contenido hay en la VRAM
                        <strong>‚Üí Resultado: Pantalla blanca (VRAM vac√≠a)</strong></li>
                    <li>[ ] Verificar si el c√≥digo del juego est√° ejecutando las instrucciones que copian datos a VRAM
                        <ul>
                            <li>Implementar logging de escrituras a VRAM (0x8000-0x9FFF) para ver si se est√°n escribiendo datos</li>
                            <li>Verificar si el DMA (Direct Memory Access) est√° funcionando correctamente</li>
                            <li>Ejecutar paso a paso para identificar d√≥nde se detiene la inicializaci√≥n antes de cargar gr√°ficos</li>
                        </ul>
                    </li>
                    <li>[ ] Si el c√≥digo no se est√° ejecutando: verificar si hay un bloqueo en la CPU o un error antes de llegar a las instrucciones de carga</li>
                    <li>[ ] Si el c√≥digo se est√° ejecutando pero la VRAM no se llena: verificar la implementaci√≥n de DMA y copias manuales a VRAM</li>
                    <li>[ ] Una vez identificado y corregido el problema, desactivar el Modo Rayos X para volver al comportamiento real del hardware</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia c√≥digo de otros emuladores. Basado √∫nicamente en documentaci√≥n t√©cnica.</p>
        </footer>
    </div>
</body>
</html>

