<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forzar Modo DMG y Visual Heartbeat - Viboy Color Bit√°cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>‚ö†Ô∏è Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c√≥digo de otros emuladores. Implementaci√≥n basada √∫nicamente en documentaci√≥n t√©cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Forzar Modo DMG y Visual Heartbeat</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-18
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0046
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-verified">Verified</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-18__0045__doctor-viboy-diagnostico-halt.html">Anterior</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Se implement√≥ el forzado de <strong>modo DMG (Game Boy Cl√°sica)</strong> en la inicializaci√≥n post-boot,
                    estableciendo el registro A a 0x01 para que los juegos Dual Mode (CGB/DMG) detecten el emulador como
                    una Game Boy Cl√°sica y usen el c√≥digo compatible con DMG en lugar de caracter√≠sticas CGB no implementadas.
                    Se a√±adi√≥ un <strong>visual heartbeat</strong> (p√≠xel parpadeante en la esquina superior izquierda) en el
                    renderer para confirmar que Pygame est√° funcionando correctamente. Se mejor√≥ el heartbeat del bucle principal
                    para incluir informaci√≥n de LCDC y BGP, facilitando el diagn√≥stico de problemas de renderizado.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    <strong>Detecci√≥n de Hardware en Game Boy</strong>: Los juegos Dual Mode (compatibles con Game Boy Cl√°sica
                    y Game Boy Color) leen el registro A al inicio para detectar el tipo de hardware:
                </p>
                <ul>
                    <li><strong>A = 0x01</strong>: Game Boy Cl√°sica (DMG - Dot Matrix Game)</li>
                    <li><strong>A = 0x11</strong>: Game Boy Color (CGB)</li>
                    <li><strong>A = 0xFF</strong>: Game Boy Pocket / Super Game Boy</li>
                </ul>
                <p>
                    En una Game Boy real, la Boot ROM interna establece el registro A seg√∫n el hardware detectado. Si el juego
                    detecta CGB (A=0x11), intenta usar caracter√≠sticas avanzadas como:
                </p>
                <ul>
                    <li><strong>VRAM Banks</strong>: La Game Boy Color tiene 2 bancos de VRAM (8KB cada uno) que se pueden cambiar</li>
                    <li><strong>Paletas CGB</strong>: Sistema de paletas de 15 bits (RGB555) en lugar de la paleta BGP de 4 tonos de gris</li>
                    <li><strong>Modos de prioridad</strong>: Comportamiento diferente del Bit 0 de LCDC (BG Display)</li>
                </ul>
                <p>
                    <strong>Problema identificado</strong>: Si el emulador se identifica como CGB (A=0x11) pero no implementa estas
                    caracter√≠sticas, el juego intenta usar VRAM Bank 1 o paletas CGB que no existen, resultando en una pantalla negra
                    o gr√°ficos invisibles. Al forzar A=0x01 (DMG), el juego usa el c√≥digo compatible con Game Boy Cl√°sica, que solo
                    requiere caracter√≠sticas ya implementadas (BGP de 4 tonos, VRAM Bank 0, etc.).
                </p>
                <p>
                    <strong>Visual Heartbeat</strong>: Un p√≠xel parpadeante en la esquina (0,0) confirma que Pygame est√° renderizando
                    correctamente. Si el p√≠xel parpadea, el problema es interno del emulador (no es un fallo de la ventana o Pygame).
                    Si no parpadea, el problema puede estar en la inicializaci√≥n de Pygame o en la actualizaci√≥n de la ventana.
                </p>
                <p>
                    <strong>Fuente</strong>: Pan Docs - Boot ROM, Post-Boot State, Game Boy Color detection, LCD Control Register
                </p>
            </section>

            <!-- 3. Implementaci√≥n -->
            <section id="implementacion">
                <h2>Implementaci√≥n</h2>
                
                <h3>1. Forzado de Modo DMG</h3>
                <p>
                    Se modific√≥ el m√©todo <code>_initialize_post_boot_state()</code> en <code>src/viboy.py</code> para establecer
                    expl√≠citamente el registro A a 0x01 despu√©s de inicializar PC y SP:
                </p>
                <pre><code># CR√çTICO: Forzar modo DMG (Game Boy Cl√°sica)
# A = 0x01 indica que es una Game Boy Cl√°sica, no Color
# Esto hace que los juegos Dual Mode usen el c√≥digo compatible con DMG
self._cpu.registers.set_a(0x01)</code></pre>
                <p>
                    Esto asegura que todos los juegos detecten el emulador como una Game Boy Cl√°sica desde el inicio, evitando
                    que intenten usar caracter√≠sticas CGB no implementadas.
                </p>

                <h3>2. Visual Heartbeat</h3>
                <p>
                    Se a√±adi√≥ un cuadrado parpadeante de 4x4 p√≠xeles en la esquina superior izquierda (0,0) del framebuffer en
                    <code>src/gpu/renderer.py</code>. El heartbeat se ejecuta <strong>siempre</strong>, incluso cuando el LCD est√° apagado,
                    para confirmar que Pygame est√° renderizando correctamente.
                </p>
                <pre><code># VISUAL HEARTBEAT: Dibujar un cuadrado peque√±o parpadeante en la esquina (0,0)
import time
heartbeat_on = (time.time() % 1.0) > 0.5
self.buffer.fill((255, 255, 255))
if heartbeat_on:
    pygame.draw.rect(self.buffer, (255, 0, 0), (0, 0, 4, 4))
else:
    pygame.draw.rect(self.buffer, (255, 255, 255), (0, 0, 4, 4))</code></pre>
                <p>
                    El cuadrado parpadea cada segundo (0.5s encendido, 0.5s apagado), usando color rojo brillante (255, 0, 0) cuando
                    est√° encendido. El tama√±o de 4x4 p√≠xeles (12x12 en la ventana escalada) lo hace claramente visible. Si el usuario
                    ve el cuadrado parpadeando, confirma que Pygame est√° funcionando y que el problema es interno del emulador.
                </p>
                <p>
                    <strong>Render inicial forzado</strong>: Se a√±adi√≥ un render inicial al inicio del bucle principal para mostrar
                    el heartbeat inmediatamente, incluso antes de que el juego genere V-Blanks.
                </p>
                <p>
                    <strong>Render peri√≥dico</strong>: Se a√±adi√≥ render peri√≥dico cada ~70,224 T-Cycles (1 frame) para mantener el
                    heartbeat visible incluso cuando el LCD est√° apagado o el juego no genera V-Blanks.
                </p>

                <h3>3. Monitor de LCDC y BGP en Heartbeat</h3>
                <p>
                    Se mejor√≥ el heartbeat del bucle principal en <code>src/viboy.py</code> para incluir informaci√≥n de LCDC y BGP:
                </p>
                <pre><code># Monitor de LCDC y BGP para diagn√≥stico
lcdc = self._mmu.read_byte(0xFF40)
bgp = self._mmu.read_byte(0xFF47)
logger.info(
    f"Heartbeat: PC=0x{pc:04X} | FPS={fps:.2f} | "
    f"LCDC=0x{lcdc:02X} | BGP=0x{bgp:02X}"
)</code></pre>
                <p>
                    Esto permite diagnosticar problemas de renderizado:
                </p>
                <ul>
                    <li><strong>LCDC=0x00</strong>: El juego ha apagado la pantalla (posiblemente esperando una interrupci√≥n que falla)</li>
                    <li><strong>LCDC=0x80/0x91</strong>: LCD encendido, deber√≠a renderizar</li>
                    <li><strong>BGP=0x00</strong>: Paleta completamente blanca (pantalla aparecer√° toda blanca)</li>
                    <li><strong>BGP=0xE4</strong>: Paleta est√°ndar Game Boy (blanco‚Üígris claro‚Üígris oscuro‚Üínegro)</li>
                </ul>

                <h3>Componentes creados/modificados</h3>
                <ul>
                    <li><strong>src/viboy.py</strong> (modificado): 
                        <ul>
                            <li>M√©todo <code>_initialize_post_boot_state()</code>: A√±adido forzado de A=0x01 (modo DMG)</li>
                            <li>M√©todo <code>run()</code>: Mejorado heartbeat para incluir LCDC y BGP</li>
                        </ul>
                    </li>
                    <li><strong>src/gpu/renderer.py</strong> (modificado):
                        <ul>
                            <li>M√©todo <code>render_frame()</code>: A√±adido visual heartbeat (p√≠xel parpadeante en esquina)</li>
                        </ul>
                    </li>
                </ul>

                <h3>Decisiones de dise√±o</h3>
                <p>
                    <strong>Por qu√© forzar A=0x01 en lugar de implementar CGB</strong>: Implementar caracter√≠sticas CGB completas
                    (VRAM Banks, paletas CGB, etc.) es un trabajo extenso que requiere cambios significativos en la PPU y el renderer.
                    Forzar modo DMG es una soluci√≥n temporal que permite que los juegos Dual Mode funcionen inmediatamente usando
                    solo caracter√≠sticas ya implementadas. Cuando se implementen caracter√≠sticas CGB en el futuro, se podr√° cambiar
                    A a 0x11 o detectar autom√°ticamente seg√∫n el tipo de ROM.
                </p>
                <p>
                    <strong>Visual Heartbeat como herramienta de diagn√≥stico</strong>: El p√≠xel parpadeante es una forma simple y
                    efectiva de confirmar que Pygame est√° funcionando. Si el usuario no ve el p√≠xel parpadeando, el problema est√°
                    en la inicializaci√≥n de Pygame o en la actualizaci√≥n de la ventana. Si lo ve, el problema es interno del
                    emulador (renderizado, VRAM, tilemap, etc.).
                </p>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/viboy.py</code> (modificado):
                        <ul>
                            <li>M√©todo <code>_initialize_post_boot_state()</code>: Forzado de A=0x01 (modo DMG) con verificaci√≥n y logging mejorado</li>
                            <li>M√©todo <code>run()</code>: Heartbeat inicial al inicio del bucle, heartbeat mejorado con LCDC y BGP, render inicial forzado, render peri√≥dico cada frame</li>
                            <li>A√±adido contador <code>_cycles_since_render</code> para controlar render peri√≥dico</li>
                        </ul>
                    </li>
                    <li><code>src/gpu/renderer.py</code> (modificado):
                        <ul>
                            <li>M√©todo <code>render_frame()</code>: Visual heartbeat como cuadrado de 4x4 p√≠xeles, ejecutado siempre (incluso con LCD apagado), usando <code>pygame.draw.rect()</code></li>
                        </ul>
                    </li>
                    <li><code>docs/bitacora/entries/2025-12-18__0046__forzar-modo-dmg-heartbeat-visual.html</code> (nuevo) - Entrada de bit√°cora</li>
                    <li><code>docs/bitacora/index.html</code> (modificado) - A√±adida entrada 0046</li>
                    <li><code>docs/bitacora/entries/2025-12-18__0045__doctor-viboy-diagnostico-halt.html</code> (modificado) - Actualizado link "Siguiente"</li>
                    <li><code>INFORME_COMPLETO.md</code> (modificado) - A√±adida entrada con verificaci√≥n</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificaci√≥n -->
            <section id="tests">
                <h2>Tests y Verificaci√≥n</h2>
                <p>
                    <strong>Estado</strong>: <span class="tag tag-verified">Verified</span> - Verificado con Tetris DX
                </p>
                
                <h3>Verificaci√≥n con Tetris DX</h3>
                <p>
                    <strong>ROM</strong>: Tetris DX (ROM aportada por el usuario, no distribuida)
                </p>
                <p>
                    <strong>Comando ejecutado</strong>: <code>python main.py tetris_dx.gbc</code>
                </p>
                <p>
                    <strong>Entorno</strong>: Windows 10, Python 3.13.5, pygame-ce 2.5.6
                </p>
                
                <h4>Resultados de Verificaci√≥n</h4>
                <ul>
                    <li><strong>‚úÖ Registro A</strong>: Correctamente establecido a 0x01 (DMG mode)
                        <pre><code>INFO: ‚úÖ Post-Boot State: PC=0x0100, SP=0xFFFE, A=0x01 (DMG mode forzado)
INFO: üöÄ Inicio: PC=0x0100 | A=0x01 (DMG=‚úÖ) | LCDC=0x00 | BGP=0xE4</code></pre>
                    </li>
                    <li><strong>‚úÖ Heartbeat del bucle principal</strong>: Funciona correctamente, muestra PC, A, LCDC y BGP
                        <pre><code>INFO: üöÄ Inicio: PC=0x0100 | A=0x01 (DMG=‚úÖ) | LCDC=0x00 | BGP=0xE4</code></pre>
                    </li>
                    <li><strong>‚úÖ Visual Heartbeat</strong>: Implementado como cuadrado rojo parpadeante de 4x4 p√≠xeles (12x12 en ventana escalada)
                        <ul>
                            <li>Se renderiza siempre, incluso cuando LCD est√° apagado (LCDC=0x00)</li>
                            <li>Render inicial forzado al inicio del bucle principal</li>
                            <li>Render peri√≥dico cada ~70,224 T-Cycles (1 frame) para mantener visibilidad</li>
                        </ul>
                    </li>
                </ul>
                
                <h4>Correcciones Realizadas</h4>
                <p>
                    Durante la verificaci√≥n inicial, se identificaron y corrigieron los siguientes problemas:
                </p>
                <ol>
                    <li><strong>Visual heartbeat no visible</strong>:
                        <ul>
                            <li><strong>Problema</strong>: El heartbeat solo se ejecutaba cuando el LCD estaba encendido, y solo se renderizaba en V-Blank</li>
                            <li><strong>Soluci√≥n</strong>: Movido al inicio de <code>render_frame()</code> para ejecutarse siempre, a√±adido render inicial forzado y render peri√≥dico cada frame</li>
                        </ul>
                    </li>
                    <li><strong>Heartbeat demasiado peque√±o</strong>:
                        <ul>
                            <li><strong>Problema</strong>: 1 p√≠xel era dif√≠cil de ver despu√©s del escalado</li>
                            <li><strong>Soluci√≥n</strong>: Cambiado a cuadrado de 4x4 p√≠xeles (12x12 en ventana escalada) usando <code>pygame.draw.rect()</code></li>
                        </ul>
                    </li>
                    <li><strong>Heartbeat del bucle principal no se mostraba</strong>:
                        <ul>
                            <li><strong>Problema</strong>: Solo se mostraba cada 60 frames en V-Blank, y el juego no entraba en V-Blank</li>
                            <li><strong>Soluci√≥n</strong>: A√±adido heartbeat inicial al inicio del bucle y tambi√©n en el primer frame</li>
                        </ul>
                    </li>
                </ol>
                
                <h4>C√≥digo del Visual Heartbeat</h4>
                <pre><code># VISUAL HEARTBEAT: Dibujar un cuadrado peque√±o parpadeante en la esquina (0,0)
import time
heartbeat_on = (time.time() % 1.0) > 0.5
self.buffer.fill((255, 255, 255))
if heartbeat_on:
    pygame.draw.rect(self.buffer, (255, 0, 0), (0, 0, 4, 4))
else:
    pygame.draw.rect(self.buffer, (255, 255, 255), (0, 0, 4, 4))</code></pre>
                
                <p>
                    <strong>Notas legales</strong>: La ROM comercial mencionada es aportada por el usuario para pruebas locales.
                    No se distribuye, no se enlaza descarga, y no se sube al repositorio.
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/">Boot ROM, Post-Boot State</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/">Game Boy Color detection</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/">LCD Control Register (LCDC)</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/">Background Palette (BGP)</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Detecci√≥n de hardware</strong>: Los juegos Dual Mode leen el registro A al inicio para detectar el tipo de hardware. A=0x01 indica Game Boy Cl√°sica, A=0x11 indica Game Boy Color.</li>
                        <li><strong>Comportamiento Dual Mode</strong>: Los juegos Dual Mode tienen dos rutas de c√≥digo: una para DMG (compatible) y otra para CGB (con caracter√≠sticas avanzadas). Al forzar A=0x01, el juego usa la ruta DMG.</li>
                        <li><strong>Visual Heartbeat</strong>: Un p√≠xel parpadeante es una herramienta simple y efectiva para confirmar que Pygame est√° funcionando. Si el p√≠xel parpadea, el problema es interno del emulador.</li>
                        <li><strong>Monitor de LCDC/BGP</strong>: Los valores de LCDC y BGP en el heartbeat permiten diagnosticar problemas de renderizado sin necesidad de logs detallados.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Verificaci√≥n con ROMs reales</strong>: Pendiente de probar con Tetris DX y Super Mario Bros. Deluxe para confirmar que detectan modo DMG y renderizan correctamente.</li>
                        <li><strong>Comportamiento de otros juegos</strong>: Algunos juegos pueden tener l√≥gica de detecci√≥n m√°s compleja o pueden requerir caracter√≠sticas CGB m√≠nimas incluso en modo DMG.</li>
                        <li><strong>Impacto en juegos DMG puros</strong>: Los juegos que solo funcionan en Game Boy Cl√°sica deber√≠an seguir funcionando igual, pero debe verificarse.</li>
                    </ul>

                    <h3>Hip√≥tesis y Suposiciones</h3>
                    <p>
                        <strong>Hip√≥tesis principal</strong>: Forzar A=0x01 har√° que los juegos Dual Mode usen el c√≥digo compatible con DMG,
                        evitando que intenten usar caracter√≠sticas CGB no implementadas y resultando en renderizado correcto (no pantalla negra).
                    </p>
                    <p>
                        <strong>Suposici√≥n</strong>: El visual heartbeat ser√° visible si Pygame est√° funcionando correctamente. Si no es visible,
                        el problema est√° en la inicializaci√≥n de Pygame o en la actualizaci√≥n de la ventana.
                    </p>
                </div>
            </section>

            <!-- 8. Pr√≥ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr√≥ximos Pasos</h2>
                <ul>
                    <li>[‚úÖ] Verificar con Tetris DX que detecta modo DMG (A=0x01) - <strong>COMPLETADO</strong>: Registro A correcto (0x01)</li>
                    <li>[‚úÖ] Confirmar que el visual heartbeat es visible - <strong>COMPLETADO</strong>: Cuadrado rojo parpadeante visible</li>
                    <li>[‚úÖ] Verificar que el heartbeat muestra LCDC y BGP correctamente - <strong>COMPLETADO</strong>: Heartbeat muestra LCDC y BGP</li>
                    <li>[ ] Verificar con Super Mario Bros. Deluxe que funciona en modo DMG</li>
                    <li>[ ] Investigar por qu√© los juegos siguen mostrando pantalla negra/blanca a pesar de que el registro A es correcto (posibles causas: VRAM vac√≠a, tilemap no inicializado, paletas incorrectas, LCDC apagado durante inicializaci√≥n)</li>
                    <li>[ ] En el futuro, implementar caracter√≠sticas CGB completas (VRAM Banks, paletas CGB) para soportar modo CGB nativo</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia c√≥digo de otros emuladores. Basado √∫nicamente en documentaci√≥n t√©cnica.</p>
        </footer>
    </div>
</body>
</html>

