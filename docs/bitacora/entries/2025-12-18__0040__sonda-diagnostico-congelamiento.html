<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonda de Diagn√≥stico para Congelamiento - Viboy Color Bit√°cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>‚ö†Ô∏è Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c√≥digo de otros emuladores. Implementaci√≥n basada √∫nicamente en documentaci√≥n t√©cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Sonda de Diagn√≥stico para Congelamiento</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-18
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0040
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-draft">Draft</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-18__0039__capa-window.html">Anterior</a></li>
                    <li><a href="2025-12-18__0041__verificacion-conexion-mmu-ppu-limpieza-debug.html">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Se implement√≥ una <strong>sonda de diagn√≥stico</strong> en el bucle principal del emulador para identificar
                    d√≥nde se atasca la ejecuci√≥n cuando el emulador parece congelarse. La sonda imprime informaci√≥n peri√≥dica
                    del estado del sistema (PC, SP, IME, LY, IF, IE, LCDC) cada 1000 iteraciones usando <code>print()</code>
                    directo para evitar buffering de logging. Adem√°s, se a√±adi√≥ un log especial cuando LY llega a 144 (V-Blank)
                    para verificar si las interrupciones se activan correctamente. Se a√±adi√≥ tambi√©n una llamada expl√≠cita a
                    <code>pygame.event.pump()</code> al inicio de cada iteraci√≥n para evitar que Windows marque la ventana como
                    "No responde". Con esta instrumentaci√≥n, se descubri√≥ que el emulador <strong>NO se congela</strong>: est√°
                    ejecutando c√≥digo normalmente, pero el juego parece estar en un bucle esperando interrupciones V-Blank.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    Cuando un emulador parece "congelarse", hay tres causas principales:
                </p>
                <ol>
                    <li><strong>Bucle Infinito en CPU:</strong> El juego espera una interrupci√≥n (ej: V-Blank) que nunca llega
                        o que la CPU no procesa, qued√°ndose en un <code>JR -2</code> eterno (bucle de espera activa).</li>
                    <li><strong>Bloqueo Gr√°fico:</strong> La librer√≠a gr√°fica (Pygame) est√° esperando a dibujar algo y no le llegan
                        datos, bloqueando la ventana (aparece "No responde" en Windows).</li>
                    <li><strong>Error Silencioso:</strong> Hay una excepci√≥n ocurriendo en un hilo o proceso que no estamos viendo.</li>
                </ol>
                
                <p>
                    Para diagnosticar el problema, necesitamos <strong>instrumentaci√≥n</strong> que nos muestre el estado interno
                    del emulador peri√≥dicamente:
                </p>
                <ul>
                    <li><strong>PC (Program Counter):</strong> Si se repite, est√° en un bucle. Si avanza, est√° ejecutando c√≥digo.</li>
                    <li><strong>LY (L√≠nea actual):</strong> Si siempre es 0, el Timer/PPU no avanza. Si avanza, la PPU funciona.</li>
                    <li><strong>IME (Interrupt Master Enable):</strong> Si es False y IF tiene bits, la CPU est√° ignorando interrupciones.</li>
                    <li><strong>IF (Interrupt Flag):</strong> Indica qu√© interrupciones est√°n pendientes (bit 0 = V-Blank).</li>
                    <li><strong>IE (Interrupt Enable):</strong> Indica qu√© interrupciones est√°n habilitadas (bit 0 = V-Blank).</li>
                    <li><strong>LCDC:</strong> Indica si la pantalla est√° encendida (bit 7 = 1).</li>
                </ul>
                
                <p>
                    <strong>Pygame Event Pump:</strong> En Windows, si no se llama a <code>pygame.event.pump()</code> frecuentemente,
                    el sistema operativo marca la ventana como "No responde" porque no est√° procesando mensajes de la cola de eventos.
                    Esto puede hacer que la ventana parezca congelada aunque el emulador est√© ejecutando c√≥digo normalmente.
                </p>
            </section>

            <!-- 3. Implementaci√≥n -->
            <section id="implementacion">
                <h2>Implementaci√≥n</h2>
                <p>
                    Se modific√≥ el m√©todo <code>run()</code> en <code>src/viboy.py</code> para a√±adir instrumentaci√≥n de diagn√≥stico
                    sin tocar la l√≥gica de emulaci√≥n.
                </p>
                
                <h3>Componentes modificados</h3>
                <ul>
                    <li><strong>src/viboy.py:</strong> A√±adida sonda de diagn√≥stico en el bucle principal</li>
                </ul>

                <h3>Cambios realizados</h3>
                <ol>
                    <li><strong>Importaci√≥n de sys:</strong> A√±adido <code>import sys</code> para poder usar <code>sys.exit()</code>
                        en el l√≠mite de seguridad.</li>
                    
                    <li><strong>Contador de diagn√≥stico:</strong> A√±adida variable <code>debug_counter = 0</code> que se incrementa
                        en cada iteraci√≥n del bucle principal.</li>
                    
                    <li><strong>Llamada expl√≠cita a pygame.event.pump():</strong> A√±adida al inicio de cada iteraci√≥n del bucle
                        (antes de <code>_handle_pygame_events()</code>) para evitar que Windows marque la ventana como "No responde".</li>
                    
                    <li><strong>Sonda peri√≥dica:</strong> Cada 1000 iteraciones, imprime informaci√≥n de diagn√≥stico usando <code>print()</code>
                        directo (para evitar buffering de logging):
                        <pre><code>DEBUG PROBE: iter=1000 | PC=1387 | SP=FFFC | IME=False | LY=12 | IF=00 | IE=00 | LCDC=00</code></pre>
                    </li>
                    
                    <li><strong>Log especial de V-Blank:</strong> Cuando LY llega a 144, imprime un log especial para verificar
                        si la interrupci√≥n V-Blank se activa:
                        <pre><code>üîµ V-BLANK DETECTADO: LY=144 | IF=01 | IE=01 | IME=False</code></pre>
                    </li>
                    
                    <li><strong>L√≠mite de seguridad:</strong> Despu√©s de 50000 iteraciones, el emulador se detiene autom√°ticamente
                        para evitar bucles infinitos que inunden la terminal.</li>
                </ol>

                <h3>Decisiones de dise√±o</h3>
                <ul>
                    <li><strong>Uso de print() directo:</strong> Se usa <code>print()</code> en lugar de <code>logger.info()</code>
                        para evitar buffering y asegurar que los mensajes aparezcan inmediatamente en la consola.</li>
                    <li><strong>Frecuencia de 1000 iteraciones:</strong> Suficientemente frecuente para detectar bucles, pero no tan
                        frecuente como para saturar la terminal. Cada 1000 iteraciones ‚âà cada ~250 instrucciones (dependiendo de ciclos).</li>
                    <li><strong>L√≠mite de 50000 iteraciones:</strong> Permite capturar ~50 muestras antes de detenerse, suficiente para
                        identificar patrones de comportamiento.</li>
                </ul>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/viboy.py</code> - A√±adida sonda de diagn√≥stico en m√©todo <code>run()</code>:
                        <ul>
                            <li>Importaci√≥n de <code>sys</code></li>
                            <li>Contador <code>debug_counter</code></li>
                            <li>Llamada a <code>pygame.event.pump()</code> al inicio de cada iteraci√≥n</li>
                            <li>Sonda peri√≥dica cada 1000 iteraciones</li>
                            <li>Log especial cuando LY = 144</li>
                            <li>L√≠mite de seguridad de 50000 iteraciones</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <!-- 5. Tests y Verificaci√≥n -->
            <section id="tests">
                <h2>Tests y Verificaci√≥n</h2>
                <p>
                    Esta es una modificaci√≥n de diagn√≥stico, no una funcionalidad nueva. No se crearon tests unitarios,
                    pero se ejecut√≥ el emulador con una ROM comercial para verificar que la sonda funciona correctamente.
                </p>
                
                <h3>Ejecuci√≥n de ROM (Diagn√≥stico)</h3>
                <ul>
                    <li><strong>ROM:</strong> Tetris DX (ROM aportada por el usuario, no distribuida)</li>
                    <li><strong>Modo de ejecuci√≥n:</strong> UI con Pygame, logging en nivel INFO</li>
                    <li><strong>Comando ejecutado:</strong> <code>python main.py tetris_dx.gbc</code></li>
                    <li><strong>Entorno:</strong> Windows 10, Python 3.13.5, pygame-ce 2.5.6</li>
                    <li><strong>Criterio de √©xito:</strong> Ver l√≠neas <code>DEBUG PROBE</code> peri√≥dicamente en la consola</li>
                    <li><strong>Observaci√≥n:</strong>
                        <pre><code>DEBUG PROBE: iter=1000 | PC=1387 | SP=FFFC | IME=False | LY=12 | IF=00 | IE=00 | LCDC=00
DEBUG PROBE: iter=2000 | PC=1386 | SP=FFFC | IME=False | LY=25 | IF=00 | IE=00 | LCDC=00
DEBUG PROBE: iter=3000 | PC=1385 | SP=FFFC | IME=False | LY=37 | IF=00 | IE=00 | LCDC=00
DEBUG PROBE: iter=4000 | PC=1384 | SP=FFFC | IME=False | LY=50 | IF=00 | IE=00 | LCDC=00
DEBUG PROBE: iter=5000 | PC=1383 | SP=FFFC | IME=False | LY=62 | IF=00 | IE=00 | LCDC=00
DEBUG PROBE: iter=6000 | PC=1389 | SP=FFFC | IME=False | LY=75 | IF=00 | IE=00 | LCDC=00
DEBUG PROBE: iter=7000 | PC=1388 | SP=FFFC | IME=False | LY=87 | IF=00 | IE=00 | LCDC=00</code></pre>
                    </li>
                    <li><strong>An√°lisis de resultados:</strong>
                        <ul>
                            <li>‚úÖ <strong>PC est√° cambiando:</strong> 1387 ‚Üí 1386 ‚Üí 1385 ‚Üí 1384 ‚Üí 1383 ‚Üí 1389 ‚Üí 1388. El emulador NO se congela, est√° ejecutando c√≥digo.</li>
                            <li>‚úÖ <strong>LY est√° avanzando:</strong> 12 ‚Üí 25 ‚Üí 37 ‚Üí 50 ‚Üí 62 ‚Üí 75 ‚Üí 87. La PPU funciona correctamente.</li>
                            <li>‚ö†Ô∏è <strong>IME=False:</strong> Las interrupciones est√°n deshabilitadas, por lo que aunque IF se active, no se procesar√°n.</li>
                            <li>‚ö†Ô∏è <strong>IF=00:</strong> No hay interrupciones pendientes. Esto podr√≠a indicar que V-Blank no se est√° activando o se est√° limpiando inmediatamente.</li>
                            <li>‚ö†Ô∏è <strong>IE=00:</strong> No hay interrupciones habilitadas. El juego no ha configurado IE todav√≠a.</li>
                            <li>‚ö†Ô∏è <strong>LCDC=00:</strong> La pantalla est√° apagada (bit 7 = 0). Esto es normal al inicio, pero el juego deber√≠a activarla.</li>
                        </ul>
                    </li>
                    <li><strong>Resultado:</strong> <span class="tag tag-draft">Draft</span> - La sonda funciona correctamente y revela que el emulador NO se congela. El juego est√° ejecutando c√≥digo pero parece estar en un bucle esperando interrupciones V-Blank. Se necesita m√°s investigaci√≥n para entender por qu√© el juego no avanza.</li>
                    <li><strong>Notas legales:</strong> ROM comercial aportada por el usuario para pruebas locales. No se distribuye ni se incluye en el repositorio.</li>
                </ul>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/">Interrupts, V-Blank, LCD Timing</a></li>
                    <li>Pygame Documentation: <a href="https://www.pygame.org/docs/ref/event.html#pygame.event.pump">pygame.event.pump()</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Diagn√≥stico de congelamiento:</strong> Cuando un emulador parece congelarse, la primera herramienta
                            es a√±adir instrumentaci√≥n para ver qu√© est√° pasando internamente. Los valores de PC, LY, IME, IF, IE y LCDC
                            proporcionan informaci√≥n valiosa sobre el estado del sistema.</li>
                        <li><strong>Pygame Event Pump:</strong> En Windows, es cr√≠tico llamar a <code>pygame.event.pump()</code> frecuentemente
                            para evitar que el sistema operativo marque la ventana como "No responde". Esto no es un problema del emulador,
                            sino del sistema operativo esperando que la aplicaci√≥n procese mensajes de la cola de eventos.</li>
                        <li><strong>Bucle de espera activa:</strong> Muchos juegos de Game Boy esperan interrupciones V-Blank haciendo polling
                            de LY o esperando que IME se active. Si IME est√° deshabilitado y el juego no lo activa, puede quedar atascado.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Por qu√© el juego no avanza:</strong> El juego est√° ejecutando c√≥digo (PC cambia) y la PPU funciona (LY avanza),
                            pero parece estar en un bucle esperando algo. Necesito verificar:
                            <ul>
                                <li>¬øSe activa IF cuando LY llega a 144?</li>
                                <li>¬øEl juego activa IE en alg√∫n momento?</li>
                                <li>¬øEl juego ejecuta EI (Enable Interrupts) para activar IME?</li>
                                <li>¬øQu√© c√≥digo est√° ejecutando en las direcciones 0x1383-0x1389?</li>
                            </ul>
                        </li>
                        <li><strong>Estado inicial del juego:</strong> Necesito verificar si el juego espera que la pantalla est√© encendida
                            (LCDC bit 7 = 1) antes de continuar, o si hay alguna otra condici√≥n que no se est√° cumpliendo.</li>
                    </ul>

                    <h3>Hip√≥tesis y Suposiciones</h3>
                    <p>
                        <strong>Hip√≥tesis principal:</strong> El juego est√° en un bucle de espera activa esperando que se active la interrupci√≥n
                        V-Blank, pero como IME=False, las interrupciones no se procesan. El juego probablemente ejecutar√° <code>EI</code>
                        (Enable Interrupts) en alg√∫n momento para activar IME, pero puede que est√© esperando alguna otra condici√≥n primero
                        (por ejemplo, que la pantalla est√© encendida o que alg√∫n registro est√© en un valor espec√≠fico).
                    </p>
                    <p>
                        <strong>Suposici√≥n no verificada:</strong> Asumo que el juego deber√≠a activar IE y ejecutar EI en alg√∫n momento durante
                        la inicializaci√≥n. Si esto no ocurre, puede ser un bug en la emulaci√≥n o una condici√≥n que no se est√° cumpliendo.
                    </p>
                </div>
            </section>

            <!-- 8. Pr√≥ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr√≥ximos Pasos</h2>
                <ul>
                    <li>[ ] Ejecutar el emulador de nuevo con la sonda mejorada (incluye IE y LCDC) para ver si IE se activa</li>
                    <li>[ ] Verificar si IF se activa cuando LY llega a 144 (usando el log especial de V-Blank)</li>
                    <li>[ ] Analizar qu√© c√≥digo est√° ejecutando el juego en las direcciones 0x1383-0x1389 (posible bucle de espera)</li>
                    <li>[ ] Verificar si el juego espera que LCDC bit 7 = 1 antes de continuar</li>
                    <li>[ ] Si el problema persiste, considerar a√±adir un desensamblador b√°sico para ver qu√© instrucciones se est√°n ejecutando</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia c√≥digo de otros emuladores. Basado √∫nicamente en documentaci√≥n t√©cnica.</p>
        </footer>
    </div>
</body>
</html>

