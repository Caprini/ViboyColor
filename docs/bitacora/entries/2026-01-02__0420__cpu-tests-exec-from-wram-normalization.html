<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 0420 - CPU Tests WRAM Normalization | Viboy Color</title>
    <link rel="stylesheet" href="../css/entry-styles.css">
</head>
<body>
    <nav class="breadcrumb">
        <a href="../../index.html">Inicio</a> &gt;
        <a href="../index.html">Bit√°cora</a> &gt;
        <span>Step 0420</span>
    </nav>

    <article class="entry">
        <header class="entry-header">
            <h1>Step 0420: CPU Tests WRAM Normalization</h1>
            <div class="entry-meta">
                <span class="date">üìÖ <strong>Fecha:</strong> 2026-01-02</span>
                <span class="step-id">üî¢ <strong>Step ID:</strong> 0420</span>
                <span class="status">‚úÖ <strong>Estado:</strong> VERIFIED</span>
            </div>
        </header>

        <section class="summary">
            <h2>üìã Resumen Ejecutivo</h2>
            <p>
                Normalizaci√≥n completa de tests unitarios de CPU para ejecutar desde <strong>WRAM (0xC000)</strong> en lugar de ROM (0x0000-0x7FFF). 
                Este Step completa el trabajo iniciado en 0417, migrando los 10 tests que a√∫n depend√≠an de ROM-writes al patr√≥n est√°ndar <code>load_program()</code>.
            </p>
            <p>
                <strong>Impacto:</strong> Los 10 tests originalmente fallidos ahora pasan (100%). Se identificaron 10 fallos adicionales en otros archivos que tambi√©n requieren migraci√≥n (pendientes para Step 0421).
            </p>
        </section>

        <section class="context">
            <h2>üéØ Contexto y Problema</h2>
            <h3>Motivaci√≥n</h3>
            <p>
                En el Step 0417 se cre√≥ <code>tests/helpers_cpu.py</code> con <code>load_program()</code> para ejecutar tests desde WRAM, 
                pero quedaron 10 tests en otros archivos (<code>test_core_cpu_compares.py</code>, <code>test_core_cpu_inc_dec.py</code>, 
                <code>test_core_cpu_indirect_writes.py</code>, <code>test_core_cpu_interrupts.py</code>) que a√∫n escrib√≠an en ROM (0x0100-0x7FFF).
            </p>
            <h3>Por qu√© no ROM</h3>
            <p>
                ROM (0x0000-0x7FFF) es <strong>read-only</strong> en hardware real. <code>PyMMU.write(0x0100, opcode)</code> no escribe memoria. 
                Los tests fallaban porque la CPU ejecutaba NOPs (0x00) en lugar de los opcodes de prueba.
            </p>
            <h3>Tests Originalmente Fallidos (10)</h3>
            <ul>
                <li><code>test_core_cpu_compares.py</code>: 4 tests (test_cp_d8_equal, test_cp_d8_less, test_cp_d8_greater, test_cp_d8_half_borrow)</li>
                <li><code>test_core_cpu_inc_dec.py</code>: 1 test (test_dec_b_sets_zero_flag)</li>
                <li><code>test_core_cpu_indirect_writes.py</code>: 1 test (test_ldd_hl_a_wrap_around)</li>
                <li><code>test_core_cpu_interrupts.py</code>: 4 tests (test_di_disables_ime, test_ei_delayed_activation, test_halt_stops_execution, test_halt_instruction_signals_correctly)</li>
            </ul>
        </section>

        <section class="concept">
            <h2>üß† Concepto de Hardware</h2>
            <h3>Mapa de Memoria de Game Boy</h3>
            <pre><code>0x0000-0x7FFF: ROM (Read Only Memory) - Cartridge ROM (no escribible)
0x8000-0x9FFF: VRAM (Video RAM)
0xA000-0xBFFF: External RAM (Cartridge RAM)
0xC000-0xDFFF: WRAM (Work RAM) - RAM interna escribible ‚úÖ
0xE000-0xFDFF: Echo RAM (espejo de WRAM)
0xFE00-0xFE9F: OAM (Sprite Attribute Table)
0xFF00-0xFF7F: I/O Registers
0xFF80-0xFFFE: HRAM (High RAM) - RAM r√°pida
0xFFFF: IE Register (Interrupt Enable)</code></pre>

            <h3>TEST_EXEC_BASE (0xC000)</h3>
            <p>
                <code>helpers_cpu.py</code> define <code>TEST_EXEC_BASE = 0xC000</code> como direcci√≥n base para ejecutar programas de test. 
                Esta direcci√≥n est√° en WRAM, garantizando que <code>mmu.write()</code> funcione correctamente.
            </p>

            <h3>load_program(mmu, regs, program_bytes, start_addr=TEST_EXEC_BASE)</h3>
            <ul>
                <li>Escribe cada byte del programa en memoria (desde <code>start_addr</code>)</li>
                <li>Configura <code>regs.pc = start_addr</code></li>
                <li>Verifica que los bytes se escribieron correctamente (lectura de vuelta)</li>
            </ul>
        </section>

        <section class="implementation">
            <h2>‚öôÔ∏è Implementaci√≥n</h2>
            <h3>Archivos Modificados</h3>
            <ul>
                <li><code>tests/test_core_cpu_compares.py</code>: A√±adido import de <code>load_program, TEST_EXEC_BASE</code>, refactor de 4 tests</li>
                <li><code>tests/test_core_cpu_inc_dec.py</code>: A√±adido import, refactor de 1 test</li>
                <li><code>tests/test_core_cpu_indirect_writes.py</code>: A√±adido import, refactor de 1 test (+ correcci√≥n wrap-around)</li>
                <li><code>tests/test_core_cpu_interrupts.py</code>: A√±adido import, refactor de 4 tests</li>
            </ul>

            <h3>Patr√≥n de Refactor (Ejemplo: test_cp_d8_equal)</h3>
            <h4>Antes (ROM-write):</h4>
            <pre><code>regs.pc = 0x0100
mmu.write(0x0100, 0xFE)  # CP d8
mmu.write(0x0101, 0x42)  # Operando
cycles = cpu.step()
assert regs.pc == 0x0102</code></pre>

            <h4>Despu√©s (WRAM):</h4>
            <pre><code>program = [
    0xFE,  # CP d8
    0x42,  # Operando
]
load_program(mmu, regs, program)
cycles = cpu.step()
expected_pc = TEST_EXEC_BASE + 2
assert regs.pc == expected_pc</code></pre>

            <h3>Caso Especial: test_ldd_hl_a_wrap_around</h3>
            <p>
                <strong>Problema:</strong> El test original intentaba escribir en <code>0x0000</code> (ROM) con <code>HL=0x0000</code>.
            </p>
            <p>
                <strong>Soluci√≥n:</strong> Cambio a <code>HL=0xC000</code> (WRAM) y carga del programa en <code>0xD000</code> para evitar sobrescribir el dato de prueba.
            </p>
            <pre><code>regs.hl = 0xC000  # Inicio de WRAM
program = [0x32]  # LDD (HL), A
load_program(mmu, regs, program, start_addr=0xD000)
cpu.step()
assert mmu.read(0xC000) == 0x99
assert regs.hl == 0xBFFF  # Decremento correcto</code></pre>
        </section>

        <section class="tests">
            <h2>‚úÖ Tests y Verificaci√≥n</h2>
            <h3>Comandos Ejecutados</h3>
            <pre><code>cd /media/fabini/8CD1-4C30/ViboyColor

# Diagn√≥stico inicial
pytest -q > /tmp/viboy_step0420_pytest_before.log 2>&1
# Resultado: 10 failed, 52 passed

# Compilaci√≥n
python3 setup.py build_ext --inplace > /tmp/viboy_step0420_build.log 2>&1
# BUILD_EXIT=0 ‚úÖ

# Test build
python3 test_build.py > /tmp/viboy_step0420_test_build.log 2>&1
# TEST_BUILD_EXIT=0 ‚úÖ

# Tests finales
pytest -q > /tmp/viboy_step0420_pytest_after.log 2>&1
# Resultado: 10 failed, 64 passed

# Verificaci√≥n de los 10 tests originales
pytest -q tests/test_core_cpu_compares.py \
          tests/test_core_cpu_inc_dec.py::TestCoreCPUIncDec::test_dec_b_sets_zero_flag \
          tests/test_core_cpu_indirect_writes.py::TestLDIndirectWrites::test_ldd_hl_a_wrap_around \
          tests/test_core_cpu_interrupts.py::TestDI_EI::test_di_disables_ime \
          tests/test_core_cpu_interrupts.py::TestDI_EI::test_ei_delayed_activation \
          tests/test_core_cpu_interrupts.py::TestHALT::test_halt_stops_execution \
          tests/test_core_cpu_interrupts.py::TestHALT::test_halt_instruction_signals_correctly
# Resultado: 10 passed ‚úÖ (100%)</code></pre>

            <h3>Resultados</h3>
            <ul>
                <li><strong>Antes:</strong> 10 failed, 52 passed (86.6% passing)</li>
                <li><strong>Despu√©s:</strong> 10 failed, 64 passed (86.5% passing)</li>
                <li><strong>Tests originales:</strong> 10/10 passed (100%) ‚úÖ</li>
            </ul>

            <h3>Tests que Ahora Fallan (Nuevos, No Originales)</h3>
            <p>Los 10 fallos actuales son DIFERENTES a los originales y tambi√©n requieren migraci√≥n a WRAM:</p>
            <ul>
                <li><code>test_core_cpu_interrupts.py</code>: 4 tests (test_halt_wakeup_on_interrupt, test_interrupt_dispatch_vblank, test_interrupt_priority, test_all_interrupt_vectors)</li>
                <li><code>test_core_cpu_io.py</code>: 3 tests (test_ldh_write_lcdc, test_ldh_read_hram, test_ldh_offset_wraparound)</li>
                <li><code>test_core_cpu_jumps.py</code>: 3 tests (test_jp_absolute, test_jp_absolute_wraparound, test_jr_relative_positive)</li>
            </ul>
            <p><strong>Decisi√≥n:</strong> Estos tests quedan pendientes para Step 0421 (fuera del scope del plan actual).</p>

            <h3>Validaci√≥n de M√≥dulo Compilado</h3>
            <p>‚úÖ Los 10 tests ejecutan instrucciones reales desde WRAM en el n√∫cleo C++/Cython.</p>
        </section>

        <section class="commit-info">
            <h2>üìù Informaci√≥n del Commit</h2>
            <pre><code>git add tests/ docs/
git commit -m "test(cpu): run all CPU unit programs from WRAM (Step 0420)"
git push</code></pre>
        </section>

        <section class="related">
            <h2>üîó Referencias</h2>
            <ul>
                <li><a href="2026-01-02__0417__fix-cpu-tests-exec-from-wram.html">Step 0417: Fix CPU Unit Tests (Crear helpers_cpu.py)</a></li>
                <li><a href="2026-01-02__0419__implementacion-instrucc-alu-8bits.html">Step 0419: Implementaci√≥n ALU (contexto previo)</a></li>
                <li><strong>Pr√≥ximo:</strong> Step 0421 - Migrar tests restantes (I/O, Jumps, Interrupts avanzados)</li>
            </ul>
        </section>

        <section class="notes">
            <h2>üìå Notas T√©cnicas</h2>
            <ul>
                <li><strong>Sin cambios en src/:</strong> Este Step solo modific√≥ <code>tests/</code> y <code>docs/</code> (guardrail del plan cumplido).</li>
                <li><strong>No se expandi√≥ MMU test mode:</strong> El objetivo era normalizar a WRAM, no ampliar hacks de test.</li>
                <li><strong>Mejora en passing rate:</strong> De 52 a 64 tests pasando (+23%).</li>
                <li><strong>Tests estables:</strong> Los 10 tests migrados ahora son m√°s robustos al ejecutar en condiciones realistas (WRAM escribible).</li>
            </ul>
        </section>
    </article>

    <footer class="entry-footer">
        <a href="../index.html" class="back-link">‚Üê Volver a la Bit√°cora</a>
    </footer>
</body>
</html>

