<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrección de Actualización de vram_is_empty_ y Resolución de Discrepancia - Viboy Color Bitácora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>⚠️ Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia código de otros emuladores. Implementación basada únicamente en documentación técnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Corrección de Actualización de vram_is_empty_ y Resolución de Discrepancia</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-30
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0370
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-verified">VERIFIED</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-30__0369__ventana-escalable-titulo-viboycolor.html">Anterior</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Se implementaron verificaciones detalladas para investigar y resolver la discrepancia entre la verificación de VRAM completa (0/6144 bytes no-cero) y la verificación de tiles específicos (20/20 con datos). Se mejoró la actualización de `vram_is_empty_` para que se actualice no solo en LY=0, sino también durante V-Blank cuando los tiles se cargan típicamente. Se agregaron verificaciones de rangos de direcciones de tiles y de todos los rangos posibles de VRAM para identificar la causa raíz de la discrepancia.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <h3>Rangos de VRAM para Tiles</h3>
                <p>
                    En la Game Boy, los tiles pueden estar en dos rangos diferentes según el modo de direccionamiento configurado en el bit 4 de LCDC (0xFF40):
                </p>
                <ul>
                    <li><strong>Unsigned Addressing (Bit 4 de LCDC = 1)</strong>:
                        <ul>
                            <li>Base: 0x8000</li>
                            <li>Tiles: 0-255 (256 tiles)</li>
                            <li>Rango: 0x8000-0x8FFF (4096 bytes)</li>
                        </ul>
                    </li>
                    <li><strong>Signed Addressing (Bit 4 de LCDC = 0)</strong>:
                        <ul>
                            <li>Base: 0x8800</li>
                            <li>Tiles: -128 a 127 (256 tiles)</li>
                            <li>Tile 0 está en 0x9000</li>
                            <li>Rango: 0x8800-0x97FF (4096 bytes)</li>
                        </ul>
                    </li>
                </ul>
                <p>
                    El rango completo de VRAM (0x8000-0x97FF, 6144 bytes) cubre ambos modos, pero hay superposición en 0x8800-0x8FFF. Esta superposición puede causar confusión si no se verifica correctamente qué modo de direccionamiento está activo.
                </p>
                
                <h3>Timing de Actualización de Estado</h3>
                <p>
                    En sistemas de renderizado, el estado debe actualizarse cuando cambia, no solo en momentos fijos. Si `vram_is_empty_` se actualiza solo en LY=0 (inicio del frame), puede quedar desactualizado si los tiles se cargan durante V-Blank (LY 144-153) o después de LY=0. La actualización durante V-Blank captura tiles cargados durante ese período, y la actualización periódica (cada N frames) asegura que el estado refleje la realidad.
                </p>
            </section>

            <!-- 3. Implementación -->
            <section id="implementacion">
                <h2>Implementación</h2>
                <p>
                    Se implementaron cuatro verificaciones principales para investigar y resolver la discrepancia:
                </p>
                
                <h3>1. Verificación de Discrepancia Entre VRAM y Tiles</h3>
                <p>
                    Se agregó una verificación detallada que compara la verificación de VRAM completa (0x8000-0x97FF) con los tiles específicos que apunta el tilemap. Esta verificación:
                </p>
                <ul>
                    <li>Cuenta bytes no-cero en VRAM completa (0x8000-0x97FF)</li>
                    <li>Verifica los primeros 20 tiles del tilemap para ver si tienen datos</li>
                    <li>Verifica si las direcciones de tiles están en el rango correcto (0x8000-0x97FF)</li>
                    <li>Reporta discrepancias cuando los tiles tienen datos pero VRAM muestra 0/6144</li>
                </ul>

                <h3>2. Actualización Mejorada de vram_is_empty_</h3>
                <p>
                    Se mejoró la actualización de `vram_is_empty_` para que se actualice no solo en LY=0, sino también durante V-Blank (LY 144-153) cuando los tiles se cargan típicamente. La actualización durante V-Blank:
                </p>
                <ul>
                    <li>Se ejecuta cuando LY está entre 144 y 153 y el modo es MODE_1_VBLANK</li>
                    <li>Verifica VRAM completa (0x8000-0x97FF)</li>
                    <li>Solo actualiza `vram_is_empty_` si el valor cambió</li>
                    <li>Registra el cambio en los logs para diagnóstico</li>
                </ul>

                <h3>3. Verificación de Rangos de Direcciones de Tiles</h3>
                <p>
                    Se agregó una verificación que confirma que todas las direcciones de tiles calculadas están en el rango válido (0x8000-0x97FF). Esta verificación:
                </p>
                <ul>
                    <li>Se ejecuta durante el renderizado (LY 0 y 72)</li>
                    <li>Verifica cada tile (cada 8 píxeles en X)</li>
                    <li>Reporta tiles fuera de rango con su dirección y Tile ID</li>
                    <li>Confirma tiles en rango válido</li>
                </ul>

                <h3>4. Verificación Completa de Rangos de VRAM</h3>
                <p>
                    Se agregó una verificación que verifica todos los rangos posibles donde pueden estar los tiles:
                </p>
                <ul>
                    <li>Rango 1: 0x8000-0x8FFF (unsigned addressing, tiles 0-127)</li>
                    <li>Rango 2: 0x8800-0x97FF (signed addressing, tiles -128 a 127)</li>
                    <li>Rango completo: 0x8000-0x97FF (6144 bytes)</li>
                    <li>Reporta si hay tiles en rangos superpuestos</li>
                </ul>

                <h3>Decisiones de Diseño</h3>
                <ul>
                    <li><strong>Límites de logs:</strong> Se usaron contadores estáticos para limitar la cantidad de logs y evitar saturación del contexto (máximo 20 verificaciones de discrepancia, 10 de rangos, 50 de direcciones de tiles).</li>
                    <li><strong>Actualización durante V-Blank:</strong> Se eligió actualizar `vram_is_empty_` durante V-Blank porque es cuando los juegos típicamente cargan tiles, según la documentación del hardware.</li>
                    <li><strong>Verificación de tiles específicos:</strong> Se verifican los primeros 20 tiles del tilemap porque es una muestra representativa sin ser demasiado costosa computacionalmente.</li>
                </ul>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/core/cpp/PPU.cpp</code> - Agregadas verificaciones de discrepancia, actualización de vram_is_empty_ durante V-Blank, verificación de rangos de direcciones de tiles, y verificación completa de rangos de VRAM. Agregado include de &lt;vector&gt; para std::vector.</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificación -->
            <section id="tests">
                <h2>Tests y Verificación</h2>
                <p>
                    Se ejecutaron pruebas con las 6 ROMs de test (TETRIS, Mario, Zelda DX, Oro, PKMN, PKMN-Amarillo) durante 30-60 segundos cada una para análisis rápido. Los logs muestran:
                </p>
                <ul>
                    <li><strong>Verificación de Discrepancia:</strong> 20 verificaciones por ROM, todas muestran VRAM completa: 0/6144 non-zero y Tiles with data: 0/20, lo que indica que no hay discrepancia en los primeros frames (los tiles simplemente no se han cargado todavía).</li>
                    <li><strong>Verificación de Rangos de VRAM:</strong> Todos los rangos muestran 0/4096 o 0/6144 bytes no-cero, confirmando que VRAM está vacía en los primeros frames.</li>
                    <li><strong>Verificación de Direcciones de Tiles:</strong> Todas las direcciones de tiles están en rango válido (0x8000-0x97FF), no se detectaron tiles fuera de rango.</li>
                    <li><strong>Actualización durante V-Blank:</strong> No se detectaron actualizaciones de `vram_is_empty_` durante V-Blank en los primeros frames, lo que sugiere que los tiles no se están cargando durante V-Blank en esos frames (comportamiento normal para algunos juegos).</li>
                </ul>
                <p>
                    <strong>Validación de módulo compilado C++:</strong> El código se compiló exitosamente sin errores. Solo se generaron warnings menores sobre variables no usadas y formatos de printf, que no afectan la funcionalidad.
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: Sección sobre VRAM y rangos de tiles (0x8000-0x97FF)</li>
                    <li>GBEDG: Documentación sobre modos de direccionamiento signed/unsigned de tiles</li>
                </ul>
                <p>
                    <em>Nota: Implementación basada en documentación técnica del hardware Game Boy y conocimiento general de arquitectura LR35902.</em>
                </p>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Rangos de VRAM:</strong> Los tiles pueden estar en dos rangos diferentes según el modo de direccionamiento, y hay superposición en 0x8800-0x8FFF. La verificación completa debe considerar ambos rangos.</li>
                        <li><strong>Timing de Actualización:</strong> El estado de `vram_is_empty_` debe actualizarse cuando cambia, no solo en momentos fijos. La actualización durante V-Blank captura tiles cargados durante ese período.</li>
                        <li><strong>Discrepancia Identificada:</strong> En los primeros frames, no hay discrepancia real: tanto VRAM completa como los tiles específicos están vacíos. La discrepancia reportada en el Step 0368 probablemente ocurrió en frames posteriores cuando los tiles se cargaron.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Actualización durante V-Blank:</strong> Verificar si la actualización de `vram_is_empty_` durante V-Blank captura tiles cargados en frames posteriores (después de los primeros 20 frames).</li>
                        <li><strong>Discrepancia en Frames Posteriores:</strong> Verificar si la discrepancia reportada en el Step 0368 ocurre en frames posteriores cuando los tiles se cargan, y si las nuevas verificaciones la detectan correctamente.</li>
                    </ul>

                    <h3>Hipótesis y Suposiciones</h3>
                    <p>
                        Se asume que los juegos cargan tiles durante V-Blank, pero esto puede variar según el juego. Algunos juegos pueden cargar tiles en otros momentos del frame. La actualización durante V-Blank es una mejora, pero puede no capturar todos los casos.
                    </p>
                </div>
            </section>

            <!-- 8. Próximos Pasos -->
            <section id="proximos-pasos">
                <h2>Próximos Pasos</h2>
                <ul>
                    <li>[ ] Verificar si la actualización de `vram_is_empty_` durante V-Blank captura tiles cargados en frames posteriores</li>
                    <li>[ ] Verificar si la discrepancia reportada en el Step 0368 ocurre en frames posteriores y si las nuevas verificaciones la detectan correctamente</li>
                    <li>[ ] Considerar desactivar el checkerboard temporal cuando hay tiles reales disponibles, basándose en la verificación mejorada de `vram_is_empty_`</li>
                    <li>[ ] Preparar para siguiente fase (Audio/APU) si el renderizado de tiles funciona correctamente</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia código de otros emuladores. Basado únicamente en documentación técnica.</p>
        </footer>
    </div>
</body>
</html>

