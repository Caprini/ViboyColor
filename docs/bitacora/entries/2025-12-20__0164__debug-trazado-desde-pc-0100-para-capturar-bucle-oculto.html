<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug: Trazado desde PC=0x0100 para Capturar Bucle Oculto - Viboy Color Bit치cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>丘멆잺 Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c칩digo de otros emuladores. Implementaci칩n basada 칰nicamente en documentaci칩n t칠cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Debug: Trazado desde PC=0x0100 para Capturar Bucle Oculto</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-20
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0164
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-draft">游댌 DRAFT</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-20__0163__verificacion-ejecucion-post-saltos-condicionales.html">Anterior</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    El deadlock de `LY=0` persiste, pero no hay warnings de opcodes no implementados, lo que indica que la CPU est치 en un bucle infinito de instrucciones v치lidas. El trazado disparado en `PC=0x0300` no se activa porque el PC est치 atascado antes. Se modifica el sistema de trazado para activarse desde el inicio de la ejecuci칩n (`PC=0x0100`) y capturar el bucle infinito en acci칩n.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    En un emulador de Game Boy, cuando la CPU est치 atrapada en un bucle infinito, el contador de l칤neas de escaneo (LY) no puede avanzar porque la CPU no est치 generando suficientes ciclos para que la PPU progrese. Este es un cl치sico <strong>deadlock del huevo y la gallina</strong>:
                </p>
                <ul>
                    <li><strong>El juego espera:</strong> El c칩digo del juego est치 esperando que la PPU haga algo (ej. entrar en V-Blank, cambiar el estado de STAT).</li>
                    <li><strong>La PPU no puede avanzar:</strong> La PPU no puede hacer nada porque `LY` no avanza.</li>
                    <li><strong>LY no avanza:</strong> `LY` no avanza porque la CPU est치 atrapada y no le da suficientes ciclos.</li>
                </ul>
                <p>
                    Si la CPU est치 ejecutando instrucciones v치lidas (sin warnings de opcodes desconocidos), pero el sistema no avanza, la 칰nica explicaci칩n l칩gica es que la CPU est치 ejecutando un peque침o bucle de c칩digo una y otra vez, tan r치pido que el acumulador de ciclos en `viboy.py` nunca llega a los 456 necesarios para avanzar una sola l칤nea de la PPU.
                </p>
                <p>
                    Para identificar este bucle, necesitamos ver qu칠 est치 haciendo la CPU desde el primer momento. El trazado "disparado" en `PC=0x0300` es in칰til si el PC nunca llega all칤. Por lo tanto, movemos el trigger al inicio del programa (`PC=0x0100`), que es donde comienza la ejecuci칩n de la ROM despu칠s del boot.
                </p>
            </section>

            <!-- 3. Implementaci칩n -->
            <section id="implementacion">
                <h2>Implementaci칩n</h2>
                <p>
                    Se modifica el sistema de trazado en `CPU.cpp` para activarse desde el inicio de la ejecuci칩n y capturar un mayor n칰mero de instrucciones para identificar el patr칩n del bucle.
                </p>
                
                <h3>Modificaciones en CPU.cpp</h3>
                <p>
                    Se cambian las constantes de trazado:
                </p>
                <ul>
                    <li><strong>DEBUG_TRIGGER_PC:</strong> De `0x0300` a `0x0100` (inicio del programa).</li>
                    <li><strong>DEBUG_INSTRUCTION_LIMIT:</strong> De `100` a `200` (para ver m치s instrucciones y capturar el patr칩n del bucle).</li>
                </ul>

                <h4>C칩digo Modificado</h4>
                <pre><code>// Variables est치ticas para logging de diagn칩stico con sistema "disparado" (triggered)
// Cambiamos el trigger al inicio del programa para ver el bucle oculto
static const uint16_t DEBUG_TRIGGER_PC = 0x0100; // Direcci칩n de activaci칩n del trazado (inicio del programa)
static bool debug_trace_activated = false;      // Bandera de activaci칩n
static int debug_instruction_counter = 0;       // Contador post-activaci칩n
// Aumentamos un poco el l칤mite para ver el patr칩n del bucle
static const int DEBUG_INSTRUCTION_LIMIT = 200; // L칤mite post-activaci칩n (aumentado para capturar bucles)</code></pre>

                <h3>Proceso de Compilaci칩n y Ejecuci칩n</h3>
                <p>
                    Para aplicar los cambios:
                </p>
                <ol>
                    <li><strong>Recompilar el m칩dulo C++:</strong> Ejecutar `.\rebuild_cpp.ps1` o `python setup.py build_ext --inplace`.</li>
                    <li><strong>Ejecutar el emulador:</strong> `python main.py roms/tetris.gb` (o cualquier ROM).</li>
                    <li><strong>Analizar la traza:</strong> La consola mostrar치 las primeras 200 instrucciones desde el inicio del programa.</li>
                </ol>

                <h3>An치lisis Esperado</h3>
                <p>
                    Al final de la traza, deber칤amos ver un patr칩n repetitivo de 2 o 3 opcodes/PCs que se repiten una y otra vez. Este ser치 nuestro bucle infinito. Un ejemplo t칤pico ser칤a:
                </p>
                <pre><code>...
[CPU TRACE 195] PC: 0x02B4 | Opcode: 0xFE (CP d8)
[CPU TRACE 196] PC: 0x02B6 | Opcode: 0x28 (JR Z, e)
[CPU TRACE 197] PC: 0x02B4 | Opcode: 0xFE (CP d8)
[CPU TRACE 198] PC: 0x02B6 | Opcode: 0x28 (JR Z, e)
[CPU TRACE 199] PC: 0x02B4 | Opcode: 0xFE (CP d8)</code></pre>
                <p>
                    Este patr칩n nos dir치 exactamente qu칠 est치 esperando el juego. Probablemente est치 haciendo un `CP` (Compare) contra un registro de hardware (como `STAT`) y esperando que cambie de valor, pero como la PPU est치 parada, ese valor nunca cambia.
                </p>
            </section>

            <!-- 4. Archivos Modificados -->
            <section id="archivos">
                <h2>Archivos Modificados</h2>
                <ul>
                    <li><code>src/core/cpp/CPU.cpp</code> - Modificaci칩n de constantes de trazado (l칤neas 8-11).</li>
                </ul>
            </section>

            <!-- 5. Pr칩ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr칩ximos Pasos</h2>
                <ol>
                    <li><strong>Recompilar y ejecutar:</strong> Aplicar los cambios y ejecutar el emulador para obtener la traza completa.</li>
                    <li><strong>Identificar el bucle:</strong> Analizar la traza para encontrar el patr칩n repetitivo al final.</li>
                    <li><strong>Determinar la causa:</strong> Entender qu칠 registro de hardware est치 esperando el juego y por qu칠 no cambia.</li>
                    <li><strong>Implementar la soluci칩n:</strong> Corregir el problema identificado (puede ser un registro de hardware no implementado, un flag de interrupci칩n, o un problema de sincronizaci칩n).</li>
                </ol>
            </section>

            <!-- 6. Referencias -->
            <section id="referencias">
                <h2>Referencias</h2>
                <ul>
                    <li><strong>Pan Docs:</strong> Secci칩n sobre el contador de l칤neas de escaneo (LY) y sincronizaci칩n CPU-PPU.</li>
                    <li><strong>GBEDG:</strong> Documentaci칩n sobre el registro STAT y flags de interrupci칩n.</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p>
                <strong>Viboy Color</strong> - Emulador de Game Boy Color (Clean-Room Implementation)
            </p>
            <p>
                Este proyecto es educativo y Open Source. Implementaci칩n basada 칰nicamente en documentaci칩n t칠cnica.
            </p>
        </footer>
    </div>
</body>
</html>

