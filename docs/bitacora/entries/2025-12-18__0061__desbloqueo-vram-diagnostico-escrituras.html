<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desbloqueo Total de VRAM y Diagn√≥stico de Escrituras - Viboy Color Bit√°cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>‚ö†Ô∏è Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c√≥digo de otros emuladores. Implementaci√≥n basada √∫nicamente en documentaci√≥n t√©cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Desbloqueo Total de VRAM y Diagn√≥stico de Escrituras</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-18
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0061
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-verified">Verified</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-18__0060__verificacion-bank-switching-mbc1.html">Anterior</a></li>
                    <li><a href="2025-12-18__0062__diagnostico-bucle-espera-vblank.html">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Tras verificar que el MBC funciona correctamente y que el LCD se enciende (LCDC=0x80), pero la pantalla
                    sigue siendo blanca incluso en modo Rayos X, la hip√≥tesis es que la MMU podr√≠a estar bloqueando escrituras
                    en VRAM (0x8000-0x9FFF) debido a restricciones de modo PPU o errores de rango. Se a√±adi√≥ logging temporal
                    para diagnosticar si el juego est√° intentando escribir gr√°ficos en VRAM y se elimin√≥ cualquier restricci√≥n
                    de escritura que pudiera existir.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    En la Game Boy, la VRAM (Video RAM, 0x8000-0x9FFF) es una regi√≥n de memoria de 8KB que almacena los datos
                    gr√°ficos: tiles (bloques de 8x8 p√≠xeles), mapas de fondo, y atributos de ventana. Durante el renderizado,
                    la PPU lee activamente esta memoria para generar la imagen en pantalla.
                </p>
                <p>
                    <strong>Restricciones de acceso a VRAM:</strong> En hardware real, la VRAM est√° bloqueada (solo lectura o
                    inaccesible) mientras la PPU est√° dibujando (Modo 3 - Pixel Transfer). Sin embargo, el hardware no bloquea
                    f√≠sicamente el acceso; simplemente puede causar artefactos visuales si la CPU escribe durante Pixel Transfer.
                    Los juegos deben hacer polling del registro STAT (0xFF41) para detectar cu√°ndo la PPU est√° en un modo seguro
                    (H-Blank o V-Blank) antes de escribir en VRAM.
                </p>
                <p>
                    <strong>Problema diagn√≥stico:</strong> Si un emulador implementa esta restricci√≥n de forma demasiado estricta
                    o err√≥nea, la CPU intenta escribir gr√°ficos, la MMU dice "¬°Acceso Denegado!", y la VRAM se queda vac√≠a
                    (blanca). Por eso es cr√≠tico verificar que las escrituras en VRAM se est√°n permitiendo correctamente.
                </p>
                <p>
                    Fuente: Pan Docs - VRAM Access Restrictions, STAT Register
                </p>
            </section>

            <!-- 3. Implementaci√≥n -->
            <section id="implementacion">
                <h2>Implementaci√≥n</h2>
                <p>
                    Se revis√≥ el m√©todo <code>write_byte</code> de la MMU para verificar si exist√≠a alg√∫n bloqueo de escritura
                    en VRAM. Tras la revisi√≥n, se confirm√≥ que <strong>no hay ninguna restricci√≥n expl√≠cita</strong> que bloquee
                    escrituras en VRAM basada en el modo PPU. El c√≥digo simplemente escribe en <code>self._memory[addr] = value</code>
                    al final del m√©todo si no es un registro especial.
                </p>
                
                <h3>Componentes modificados</h3>
                <ul>
                    <li><strong>MMU (src/memory/mmu.py)</strong>: Se a√±adi√≥ un contador <code>vram_write_count</code> en el
                        constructor para limitar el logging a las primeras 10 escrituras. Se a√±adi√≥ logging temporal en
                        <code>write_byte</code> que detecta escrituras en el rango 0x8000-0x9FFF y las registra con el mensaje
                        <code>üíæ VRAM WRITE: {value:02X} en {addr:04X}</code>.</li>
                </ul>

                <h3>Decisiones de dise√±o</h3>
                <ul>
                    <li><strong>Logging limitado a 10 escrituras:</strong> Para no saturar la consola, solo se loguean las
                        primeras 10 escrituras en VRAM. Esto es suficiente para verificar que el juego est√° intentando escribir
                        gr√°ficos.</li>
                    <li><strong>Sin bloqueo de escritura:</strong> Se confirm√≥ que no hay ning√∫n chequeo de <code>ppu.mode == 3</code>
                        o similar que bloquee escrituras. El c√≥digo permite todas las escrituras en VRAM, como debe ser. En hardware
                        real, escribir durante Pixel Transfer puede causar artefactos, pero no bloquea el acceso.</li>
                    <li><strong>Nota documental:</strong> Se a√±adi√≥ un comentario expl√≠cito en el c√≥digo que explica que no hay
                        restricci√≥n de escritura en VRAM basada en modo PPU, y que los juegos deben hacer polling de STAT para
                        evitar escribir durante Pixel Transfer.</li>
                </ul>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/memory/mmu.py</code> - A√±adido contador <code>vram_write_count</code> y logging temporal
                        para diagn√≥stico de escrituras en VRAM (0x8000-0x9FFF).</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificaci√≥n -->
            <section id="tests">
                <h2>Tests y Verificaci√≥n</h2>
                <p>
                    <strong>Estado:</strong> <span class="tag tag-verified">Verified</span>
                </p>
                <p>
                    <strong>Comando ejecutado:</strong>
                </p>
                <pre><code>python test_vram_writes.py</code></pre>
                <p>
                    <strong>Entorno:</strong> Windows 10, Python 3.13.5
                </p>
                <p>
                    <strong>ROM de prueba:</strong> Pok√©mon Red (ROM aportada por el usuario, no distribuida)
                </p>
                <p>
                    <strong>Resultado:</strong>
                </p>
                <ul>
                    <li><strong>‚úÖ S√ç aparecen mensajes de VRAM WRITE:</strong> El juego est√° intentando escribir en VRAM.
                        Se detectaron 10 escrituras durante la inicializaci√≥n (limitadas por el contador de logging).</li>
                    <li><strong>‚ö†Ô∏è PERO todos los valores son 0x00:</strong> El juego est√° escribiendo ceros en VRAM, lo que
                        explica por qu√© la pantalla es blanca. Las primeras 10 escrituras fueron:
                        <pre><code>INFO: üíæ VRAM WRITE: 00 en 8000
INFO: üíæ VRAM WRITE: 00 en 8001
INFO: üíæ VRAM WRITE: 00 en 8002
INFO: üíæ VRAM WRITE: 00 en 8003
INFO: üíæ VRAM WRITE: 00 en 8004
INFO: üíæ VRAM WRITE: 00 en 8005
INFO: üíæ VRAM WRITE: 00 en 8006
INFO: üíæ VRAM WRITE: 00 en 8007
INFO: üíæ VRAM WRITE: 00 en 8008
INFO: üíæ VRAM WRITE: 00 en 8009</code></pre>
                    </li>
                </ul>
                <p>
                    <strong>Interpretaci√≥n del resultado:</strong>
                </p>
                <ul>
                    <li>El juego <strong>S√ç est√° ejecutando c√≥digo</strong> que escribe en VRAM (no hay bloqueo de acceso).</li>
                    <li>El problema es que est√° escribiendo <strong>ceros en lugar de datos gr√°ficos reales</strong>.</li>
                    <li>Posibles causas:
                        <ul>
                            <li>El juego est√° inicializando la VRAM a ceros (comportamiento normal durante el arranque, pero deber√≠a
                                copiar datos despu√©s).</li>
                            <li>El juego intenta copiar datos desde ROM/RAM pero la fuente est√° vac√≠a o no se est√° leyendo correctamente.</li>
                            <li>Hay un problema con el DMA (Direct Memory Access) que copia datos a OAM/VRAM.</li>
                            <li>El juego est√° esperando alg√∫n evento (interrupci√≥n, cambio de modo PPU) antes de copiar los datos reales.</li>
                        </ul>
                    </li>
                </ul>
                <p>
                    <strong>Qu√© valida:</strong> Este paso confirma que:
                    <ul>
                        <li>‚úÖ La MMU NO est√° bloqueando escrituras en VRAM (las escrituras se permiten correctamente).</li>
                        <li>‚úÖ El juego est√° ejecutando c√≥digo que escribe en VRAM (no se cuelga antes de llegar a la rutina de copia).</li>
                        <li>‚ö†Ô∏è El problema es que el juego est√° escribiendo ceros en lugar de datos gr√°ficos reales.</li>
                    </ul>
                </p>
                <p>
                    <strong>Pr√≥ximo paso:</strong> Investigar por qu√© el juego est√° escribiendo ceros en VRAM. Posibles √°reas a revisar:
                    <ul>
                        <li>DMA: Verificar si el DMA est√° funcionando correctamente (registro 0xFF46).</li>
                        <li>Copias manuales: Verificar si las instrucciones de copia (LD, LDI, LDD) est√°n leyendo correctamente desde ROM/RAM.</li>
                        <li>Timing: Verificar si el juego est√° esperando alg√∫n evento (V-Blank, cambio de modo PPU) antes de copiar datos.</li>
                        <li>Inicializaci√≥n: Verificar si el juego est√° en una fase de inicializaci√≥n donde primero borra la VRAM y luego copia datos.</li>
                    </ul>
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/#vram-access-restrictions">VRAM Access Restrictions</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/#lcd-status-register-stat-ff41">LCD Status Register (STAT)</a></li>
                    <li>Pan Docs: <a href="https://gbdev.io/pandocs/#memory-map">Memory Map</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>VRAM no est√° bloqueada f√≠sicamente:</strong> Aunque la documentaci√≥n menciona que la VRAM
                            est√° "bloqueada" durante Pixel Transfer, el hardware real no bloquea f√≠sicamente el acceso. Simplemente
                            puede causar artefactos visuales si la CPU escribe durante el renderizado. Los juegos deben hacer
                            polling de STAT para evitar escribir en momentos inadecuados.</li>
                        <li><strong>Diagn√≥stico sistem√°tico:</strong> Cuando la pantalla es blanca, hay que verificar sistem√°ticamente:
                            (1) ¬øEl LCD est√° encendido? (LCDC bit 7), (2) ¬øEl MBC funciona? (bank switching), (3) ¬øEl juego escribe
                            en VRAM? (logging), (4) ¬øEl Renderer lee correctamente? (decodificaci√≥n de tiles). Este paso verifica
                            el punto (3).</li>
                        <li><strong>Logging como herramienta de diagn√≥stico:</strong> El logging temporal es una herramienta poderosa
                            para entender qu√© est√° haciendo el juego en tiempo real. Limitar el logging a las primeras N escrituras
                            evita saturar la consola mientras proporciona informaci√≥n suficiente para diagnosticar el problema.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>¬øPor qu√© el juego escribe ceros en VRAM?</strong> Se confirm√≥ que el juego S√ç escribe en VRAM,
                            pero todos los valores son 0x00. Esto podr√≠a ser:
                            <ul>
                                <li>Inicializaci√≥n normal: El juego primero borra la VRAM a ceros y luego copia datos (pero la copia
                                    no se est√° ejecutando o falla).</li>
                                <li>Problema con DMA: El DMA podr√≠a estar copiando desde una fuente vac√≠a o no estar funcionando correctamente.</li>
                                <li>Problema con copias manuales: Las instrucciones de copia (LD, LDI, LDD) podr√≠an estar leyendo ceros
                                    desde ROM/RAM o no estar ejecut√°ndose correctamente.</li>
                                <li>Timing: El juego podr√≠a estar esperando un evento (V-Blank, cambio de modo PPU) antes de copiar datos reales.</li>
                            </ul>
                        </li>
                        <li><strong>¬øEl Renderer lee correctamente la VRAM?</strong> Aunque el problema principal es que se escriben ceros,
                            tambi√©n hay que verificar que el Renderer lee correctamente la VRAM cuando hay datos v√°lidos. Esto se puede
                            verificar m√°s adelante cuando se resuelva el problema de escritura de ceros.</li>
                    </ul>

                    <h3>Hip√≥tesis y Suposiciones</h3>
                    <p>
                        <strong>Hip√≥tesis principal (CONFIRMADA):</strong> La MMU no est√° bloqueando escrituras en VRAM. El juego
                        S√ç est√° escribiendo en VRAM, pero est√° escribiendo ceros en lugar de datos gr√°ficos reales.
                    </p>
                    <p>
                        <strong>Nueva hip√≥tesis:</strong> El juego est√° en una fase de inicializaci√≥n donde primero borra la VRAM
                        a ceros y luego deber√≠a copiar datos gr√°ficos desde ROM/RAM, pero la copia no se est√° ejecutando o est√° fallando.
                        Posibles causas: (1) DMA no funciona correctamente, (2) Copias manuales leen desde fuente vac√≠a, (3) El juego
                        espera un evento que no ocurre (V-Blank, cambio de modo PPU), (4) El juego se cuelga despu√©s de borrar VRAM
                        pero antes de copiar datos.
                    </p>
                    <p>
                        <strong>Suposici√≥n:</strong> Asumimos que el logging temporal no afecta el rendimiento ni el comportamiento
                        del emulador. Si el logging causa problemas, se puede desactivar o reducir el n√∫mero de mensajes.
                    </p>
                </div>
            </section>

            <!-- 8. Pr√≥ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr√≥ximos Pasos</h2>
                <ul>
                    <li>[‚úÖ] Ejecutar ROM y verificar si aparecen mensajes <code>üíæ VRAM WRITE</code> - <strong>COMPLETADO</strong>:
                        Se confirm√≥ que el juego S√ç escribe en VRAM, pero todos los valores son 0x00.</li>
                    <li>[ ] Investigar por qu√© el juego escribe ceros en VRAM:
                        <ul>
                            <li>Verificar si el DMA est√° funcionando correctamente (registro 0xFF46).</li>
                            <li>Verificar si las instrucciones de copia (LD, LDI, LDD) est√°n leyendo correctamente desde ROM/RAM.</li>
                            <li>Verificar si el juego est√° esperando alg√∫n evento (V-Blank, cambio de modo PPU) antes de copiar datos.</li>
                            <li>A√±adir logging para rastrear lecturas desde ROM/RAM durante las copias.</li>
                        </ul>
                    </li>
                    <li>[ ] Una vez resuelto el problema de escritura de ceros, verificar que el Renderer lee correctamente la VRAM
                        cuando hay datos v√°lidos.</li>
                    <li>[ ] Reducir o eliminar el logging temporal una vez diagnosticado el problema completamente.</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia c√≥digo de otros emuladores. Basado √∫nicamente en documentaci√≥n t√©cnica.</p>
        </footer>
    </div>
</body>
</html>

