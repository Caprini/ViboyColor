<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotfix os Shadowing + Test Anti-Regresión - Viboy Color Bitácora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>⚠️ Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia código de otros emuladores. Implementación basada únicamente en documentación técnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Hotfix os Shadowing + Test Anti-Regresión</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2026-01-03
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0462
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-verified">VERIFIED</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2026-01-03__0461__inventario-debug-injection-killswitch-fix-obj-palette.html">Anterior</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Corrección crítica del bug <code>UnboundLocalError: cannot access local variable 'os'</code> que impedía que el emulador arrancara. El bug fue introducido en Step 0461 por un <code>import os</code> redundante dentro de <code>run()</code> que shadoweaba el <code>os</code> importado a nivel de módulo. Solución: Eliminación del import redundante. Test anti-regresión añadido para detectar este tipo de bugs antes del push.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    Este Step no trata sobre hardware del Game Boy, sino sobre un concepto fundamental de Python: <strong>variable shadowing</strong> y el comportamiento del intérprete al analizar funciones.
                </p>
                <p>
                    <strong>Variable Shadowing en Python</strong>: Cuando Python analiza una función, identifica todas las asignaciones a una variable (incluyendo <code>import</code>). Si encuentra una asignación a <code>os</code> en cualquier parte de la función, marca <code>os</code> como variable <strong>local</strong> para toda la función, incluso antes de que se ejecute la asignación.
                </p>
                <p>
                    <strong>El Problema</strong>: En <code>src/viboy.py</code>:
                </p>
                <ul>
                    <li>Línea 28: <code>import os</code> a nivel de módulo (correcto)</li>
                    <li>Línea 765: Uso de <code>os.environ.get()</code> dentro de <code>run()</code></li>
                    <li>Línea 777: <code>import os</code> dentro de <code>run()</code> (shadowing)</li>
                </ul>
                <p>
                    Python detecta el <code>import os</code> de la línea 777 y marca <code>os</code> como variable local para toda la función <code>run()</code>. Al ejecutar la línea 765, <code>os</code> aún no está definida localmente (el import de la línea 777 no se ha ejecutado), causando <code>UnboundLocalError</code>.
                </p>
                <p>
                    <strong>La Solución</strong>: Eliminar el import redundante. El <code>os</code> importado a nivel de módulo (línea 28) es accesible desde cualquier función del módulo, por lo que el import local es innecesario y causa el bug.
                </p>
            </section>

            <!-- 3. Implementación -->
            <section id="implementacion">
                <h2>Implementación</h2>
                <p>
                    El fix es mínimo y directo: eliminar el <code>import os</code> redundante dentro de <code>run()</code>.
                </p>
                
                <h3>Componentes modificados</h3>
                <ul>
                    <li><code>src/viboy.py</code> - Eliminado <code>import os</code> redundante en línea 777</li>
                    <li><code>tests/test_runtime_flags_no_crash_0462.py</code> - Test anti-regresión nuevo</li>
                </ul>

                <h3>Cambio aplicado</h3>
                <p>
                    <strong>Antes (línea 777)</strong>:
                </p>
                <pre><code># --- Step 0393: Toggle de trazas via variable de entorno ---
# VBC_TRACE=1 activa trazas, por defecto desactivadas para rendimiento
import os
ENABLE_DEBUG_LOGS = os.getenv('VBC_TRACE', '0') == '1'
# ------------------------------------------------------------------------------------</code></pre>

                <p>
                    <strong>Después</strong>:
                </p>
                <pre><code># --- Step 0393: Toggle de trazas via variable de entorno ---
# VBC_TRACE=1 activa trazas, por defecto desactivadas para rendimiento
# Step 0462: Eliminado import os redundante (ya importado a nivel de módulo línea 28)
ENABLE_DEBUG_LOGS = os.getenv('VBC_TRACE', '0') == '1'
# ------------------------------------------------------------------------------------</code></pre>

                <h3>Test Anti-Regresión</h3>
                <p>
                    Se creó <code>tests/test_runtime_flags_no_crash_0462.py</code> con 4 tests que verifican:
                </p>
                <ul>
                    <li><code>test_env_flag_helper_importable()</code> - Verifica que el módulo se puede importar sin shadowing</li>
                    <li><code>test_env_flag_helper_with_env_on()</code> - Verifica flags de entorno con valor '1'</li>
                    <li><code>test_env_flag_helper_with_env_off()</code> - Verifica flags de entorno con valor '0' o ausente</li>
                    <li><code>test_viboy_module_imports_without_crash()</code> - Detecta <code>UnboundLocalError</code> al importar el módulo</li>
                </ul>
                <p>
                    Estos tests son baratos (no requieren Pygame ni inicialización completa del emulador) y detectan el bug antes del push.
                </p>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/viboy.py</code> - Eliminado <code>import os</code> redundante (línea 777)</li>
                    <li><code>tests/test_runtime_flags_no_crash_0462.py</code> - Test anti-regresión nuevo (4 tests)</li>
                </ul>
            </section>

            <!-- 5. Tests y Verificación -->
            <section id="tests">
                <h2>Tests y Verificación</h2>
                <p>
                    Validación de la implementación:
                </p>
                <ul>
                    <li><strong>Test anti-regresión:</strong> 4/4 tests pasan</li>
                    <li><strong>Verificación de import:</strong> <code>python3 -c "import src.viboy"</code> ejecuta sin errores</li>
                    <li><strong>Verificación de arranque:</strong> <code>python3 main.py roms/mario.gbc</code> arranca sin <code>UnboundLocalError</code></li>
                </ul>

                <h3>Comando ejecutado</h3>
                <pre><code>pytest -v tests/test_runtime_flags_no_crash_0462.py</code></pre>

                <h3>Resultado</h3>
                <pre><code>============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0
collected 4 items

tests/test_runtime_flags_no_crash_0462.py::test_env_flag_helper_importable PASSED [ 25%]
tests/test_runtime_flags_no_crash_0462.py::test_env_flag_helper_with_env_on PASSED [ 50%]
tests/test_runtime_flags_no_crash_0462.py::test_env_flag_helper_with_env_off PASSED [ 75%]
tests/test_runtime_flags_no_crash_0462.py::test_viboy_module_imports_without_crash PASSED [100%]

============================== 4 passed in 0.32s ===============================</code></pre>

                <h3>Código del Test</h3>
                <pre><code>def test_viboy_module_imports_without_crash():
    """Verifica que el módulo viboy se puede importar sin crashes.
    
    Este test detecta UnboundLocalError y otros errores de importación.
    """
    try:
        import src.viboy
        # Si llegamos aquí, el import fue exitoso
        assert True
    except UnboundLocalError as e:
        pytest.fail(f"UnboundLocalError al importar viboy (posible shadowing): {e}")
    except Exception as e:
        # Otros errores son aceptables (ej: pygame no disponible en CI)
        # pero UnboundLocalError NO
        if "UnboundLocalError" in str(type(e)):
            pytest.fail(f"UnboundLocalError inesperado: {e}")</code></pre>

                <p>
                    <strong>Validación Nativa</strong>: Validación de módulo compilado C++ no aplicable (este fix es solo Python).
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Python Documentation: <a href="https://docs.python.org/3/tutorial/classes.html#python-scopes-and-namespaces">Scopes and Namespaces</a></li>
                    <li>Python Documentation: <a href="https://docs.python.org/3/faq/programming.html#why-am-i-getting-an-unboundlocalerror-when-the-variable-has-a-value">UnboundLocalError FAQ</a></li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Variable Shadowing en Python</strong>: Python analiza toda la función antes de ejecutarla. Si encuentra una asignación a una variable (incluyendo <code>import</code>), marca esa variable como local para toda la función, incluso antes de que se ejecute la asignación.</li>
                        <li><strong>UnboundLocalError</strong>: Ocurre cuando se intenta acceder a una variable local antes de que se haya asignado un valor. En este caso, el acceso a <code>os.environ.get()</code> en la línea 765 ocurre antes de que se ejecute el <code>import os</code> de la línea 777.</li>
                        <li><strong>Imports a Nivel de Módulo</strong>: Los imports a nivel de módulo son accesibles desde cualquier función del módulo. No es necesario re-importar dentro de funciones a menos que haya una razón específica (ej: import condicional).</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li>Nada pendiente - el fix es directo y está verificado.</li>
                    </ul>

                    <h3>Hipótesis y Suposiciones</h3>
                    <p>
                        No hay suposiciones. El comportamiento de Python está bien documentado y el fix es estándar.
                    </p>
                </div>
            </section>

            <!-- 8. Próximos Pasos -->
            <section id="proximos-pasos">
                <h2>Próximos Pasos</h2>
                <ul>
                    <li>[ ] Continuar con el desarrollo normal del emulador</li>
                    <li>[ ] Considerar añadir más tests anti-regresión para otros tipos de bugs comunes</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia código de otros emuladores. Basado únicamente en documentación técnica.</p>
        </footer>
    </div>
</body>
</html>

