<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug: Verificaci√≥n de Puntero Nulo en la PPU - Viboy Color Bit√°cora</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <div class="container">
        <!-- Aviso Clean-Room -->
        <div class="clean-room-notice">
            <strong>‚ö†Ô∏è Clean-Room / Educativo</strong>
            <p>Este proyecto es educativo y Open Source. No se copia c√≥digo de otros emuladores. Implementaci√≥n basada √∫nicamente en documentaci√≥n t√©cnica y tests permitidas.</p>
        </div>

        <!-- Header -->
        <header>
            <h1>Debug: Verificaci√≥n de Puntero Nulo en la PPU</h1>
            <div class="meta">
                <span class="meta-item">
                    <strong>Fecha:</strong> 2025-12-19
                </span>
                <span class="meta-item">
                    <strong>Step ID:</strong> 0141
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> <span class="tag tag-draft">üîç DRAFT</span>
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="2025-12-19__0140__fix-conexion-ppu-mmu-puntero-nulo.html">Anterior</a></li>
                    <li><a href="#">Siguiente</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- 1. Resumen -->
            <section id="resumen">
                <h2>Resumen</h2>
                <p>
                    Se a√±adi√≥ una verificaci√≥n de diagn√≥stico temporal en el m√©todo <code>render_scanline()</code> de la PPU 
                    para confirmar si el puntero a la MMU es nulo cuando se llama al m√©todo. Esta verificaci√≥n utiliza 
                    <code>printf</code> para emitir un mensaje cr√≠tico que confirme si el problema est√° en la capa de Cython, 
                    espec√≠ficamente en c√≥mo se pasa el puntero desde el wrapper de Cython al constructor de la PPU en C++.
                </p>
            </section>

            <!-- 2. Concepto de Hardware -->
            <section id="concepto-hardware">
                <h2>Concepto de Hardware</h2>
                <p>
                    En un emulador h√≠brido Python/C++, la comunicaci√≥n entre las capas requiere un manejo cuidadoso de los 
                    punteros. El flujo de datos desde Python hasta C++ pasa por varias capas:
                </p>
                <ol>
                    <li><strong>Python:</strong> Se crea una instancia de <code>PyMMU</code>, que contiene un puntero C++ v√°lido (<code>MMU*</code>).</li>
                    <li><strong>Python:</strong> Se crea una instancia de <code>PyPPU</code> pasando el objeto <code>PyMMU</code>.</li>
                    <li><strong>Cython:</strong> El constructor de <code>PyPPU</code> debe "desenvolver" el objeto <code>PyMMU</code> para extraer 
                        el puntero <code>MMU*</code> crudo que contiene y pas√°rselo al constructor de la PPU en C++.</li>
                    <li><strong>C++:</strong> El constructor de la PPU recibe el puntero <code>MMU*</code> y lo almacena en un miembro de la clase.</li>
                </ol>
                <p>
                    Si en cualquier punto de esta cadena el puntero se corrompe o no se pasa correctamente, la PPU intentar√° 
                    acceder a memoria inv√°lida, causando un <code>Segmentation Fault</code>. La verificaci√≥n de puntero nulo con 
                    <code>printf</code> nos permite identificar exactamente en qu√© punto falla la cadena.
                </p>
            </section>

            <!-- 3. Implementaci√≥n -->
            <section id="implementacion">
                <h2>Implementaci√≥n</h2>
                <p>
                    Se a√±adi√≥ una verificaci√≥n temporal de puntero nulo al inicio del m√©todo <code>render_scanline()</code> que 
                    imprime un mensaje cr√≠tico si el puntero <code>mmu_</code> es nulo. Esta verificaci√≥n es binaria y definitiva:
                </p>
                
                <h3>Componentes modificados</h3>
                <ul>
                    <li><strong>PPU.cpp:</strong> Se a√±adi√≥ <code>#include &lt;cstdio&gt;</code> para usar <code>printf</code>.</li>
                    <li><strong>PPU.cpp:</strong> Se a√±adi√≥ una verificaci√≥n <code>if (this->mmu_ == nullptr)</code> al inicio de 
                        <code>render_scanline()</code> que imprime un mensaje y retorna temprano para evitar el crash.</li>
                </ul>

                <h3>C√≥digo a√±adido</h3>
                <pre><code>#include &lt;cstdio&gt;

// ...

void PPU::render_scanline() {
    // CR√çTICO: Verificar que mmu_ no sea nullptr antes de acceder
    // A√ëADE ESTA VERIFICACI√ìN CR√çTICA AL INICIO DEL M√âTODO
    if (this->mmu_ == nullptr) {
        printf("[PPU CRITICAL] ¬°El puntero a la MMU es NULO! El problema est√° en la capa de Cython.\n");
        return; // Salimos pronto para evitar el crash y ver el mensaje.
    }
    
    // ... resto del m√©todo render_scanline ...
}</code></pre>

                <h3>Decisiones de dise√±o</h3>
                <p>
                    Se utiliza <code>printf</code> en lugar de <code>std::cout</code> porque es m√°s seguro para depuraci√≥n de crashes 
                    (no depende de los objetos est√°ticos de la librer√≠a est√°ndar de C++ que pueden no estar inicializados durante un crash). 
                    El mensaje es expl√≠cito y directo para identificar r√°pidamente el problema si ocurre.
                </p>
                <p>
                    <strong>Nota:</strong> Esta verificaci√≥n es temporal y ser√° eliminada una vez confirmado o descartado el problema 
                    del puntero nulo. Si el mensaje aparece, confirmaremos que el problema est√° en el wrapper de Cython. Si no aparece 
                    y el crash persiste, sabremos que el problema es m√°s profundo.
                </p>
            </section>

            <!-- 4. Archivos Tocados -->
            <section id="archivos">
                <h2>Archivos Afectados</h2>
                <ul>
                    <li><code>src/core/cpp/PPU.cpp</code> - A√±adido <code>#include &lt;cstdio&gt;</code> y verificaci√≥n de puntero nulo con <code>printf</code> en <code>render_scanline()</code></li>
                </ul>
            </section>

            <!-- 5. Tests y Verificaci√≥n -->
            <section id="tests">
                <h2>Tests y Verificaci√≥n</h2>
                <p>
                    Esta verificaci√≥n se valida mediante ejecuci√≥n real del emulador:
                </p>
                <ol>
                    <li><strong>Recompilaci√≥n:</strong> Se debe recompilar el m√≥dulo C++ con <code>.\rebuild_cpp.ps1</code>.</li>
                    <li><strong>Ejecuci√≥n:</strong> Se ejecuta el emulador con <code>python main.py roms/tetris.gb</code>.</li>
                    <li><strong>An√°lisis del resultado:</strong>
                        <ul>
                            <li><strong>Si aparece el mensaje:</strong> Confirma al 100% que el problema est√° en el wrapper de Cython 
                                (<code>ppu.pyx</code>) y sabremos exactamente d√≥nde corregirlo.</li>
                            <li><strong>Si NO aparece el mensaje y sigue habiendo crash:</strong> Nuestra hip√≥tesis es incorrecta y 
                                el problema es m√°s profundo (aunque esto es muy poco probable).</li>
                        </ul>
                    </li>
                </ol>
                <p>
                    <strong>Validaci√≥n de m√≥dulo compilado C++:</strong> Esta verificaci√≥n se ejecuta directamente en el c√≥digo 
                    compilado de C++, por lo que cualquier mensaje impreso confirmar√° que el c√≥digo C++ se est√° ejecutando correctamente 
                    y que el puntero es efectivamente nulo en ese momento.
                </p>
            </section>

            <!-- 6. Fuentes Consultadas -->
            <section id="fuentes">
                <h2>Fuentes Consultadas</h2>
                <ul>
                    <li>Documentaci√≥n de Cython: <a href="https://cython.readthedocs.io/">https://cython.readthedocs.io/</a> - Gesti√≥n de punteros C++ desde Python</li>
                    <li>Principios de depuraci√≥n de punteros: Basado en conocimiento general de depuraci√≥n de sistemas h√≠bridos Python/C++</li>
                </ul>
            </section>

            <!-- 7. Integridad Educativa -->
            <section id="integridad">
                <h2>Integridad Educativa</h2>
                <div class="integridad">
                    <h3>Lo que Entiendo Ahora</h3>
                    <ul>
                        <li><strong>Flujo de punteros en arquitectura h√≠brida:</strong> El flujo Python ‚Üí Cython ‚Üí C++ requiere 
                            un manejo cuidadoso de los punteros en cada capa. Si el puntero se corrompe en cualquier punto, 
                            el resultado ser√° un crash en tiempo de ejecuci√≥n.</li>
                        <li><strong>Diagn√≥stico binario:</strong> Las verificaciones de puntero nulo con mensajes de diagn√≥stico 
                            son herramientas efectivas para aislar problemas en sistemas h√≠bridos, ya que proporcionan una 
                            respuesta binaria: el puntero es nulo o no lo es.</li>
                    </ul>

                    <h3>Lo que Falta Confirmar</h3>
                    <ul>
                        <li><strong>Hip√≥tesis del wrapper de Cython:</strong> Necesitamos confirmar si el problema est√° en c√≥mo 
                            Cython extrae el puntero de <code>PyMMU</code> y lo pasa al constructor de la PPU. Si el mensaje 
                            aparece, confirmaremos esta hip√≥tesis.</li>
                        <li><strong>Correcci√≥n del wrapper:</strong> Si se confirma que el problema est√° en Cython, necesitaremos 
                            revisar el c√≥digo de <code>ppu.pyx</code> para corregir c√≥mo se pasa el puntero.</li>
                    </ul>

                    <h3>Hip√≥tesis y Suposiciones</h3>
                    <p>
                        <strong>Hip√≥tesis principal (99% de certeza):</strong> El puntero <code>MMU*</code> que se pasa al constructor 
                        de la PPU desde el wrapper de Cython ya es un puntero nulo (<code>nullptr</code>). El problema no est√° en la 
                        asignaci√≥n dentro del constructor de la PPU, sino en el valor que se est√° pasando.
                    </p>
                    <p>
                        Esta hip√≥tesis se basa en el hecho de que:
                    </p>
                    <ol>
                        <li>Ya hemos descartado que el problema est√© en los valores calculados (Step 0139).</li>
                        <li>Ya hemos confirmado que el constructor asigna correctamente el puntero (Step 0140).</li>
                        <li>El √∫nico punto restante en la cadena es el paso del puntero desde Cython a C++.</li>
                    </ol>
                </div>
            </section>

            <!-- 8. Pr√≥ximos Pasos -->
            <section id="proximos-pasos">
                <h2>Pr√≥ximos Pasos</h2>
                <ul>
                    <li>[ ] Recompilar el m√≥dulo C++: <code>.\rebuild_cpp.ps1</code></li>
                    <li>[ ] Ejecutar el emulador: <code>python main.py roms/tetris.gb</code></li>
                    <li>[ ] Analizar el resultado:
                        <ul>
                            <li>Si aparece el mensaje: Revisar y corregir el wrapper de Cython (<code>ppu.pyx</code>)</li>
                            <li>Si NO aparece: Investigar causas m√°s profundas del Segmentation Fault</li>
                        </ul>
                    </li>
                    <li>[ ] Eliminar la verificaci√≥n temporal una vez confirmado el problema</li>
                </ul>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p><strong>Viboy Color</strong> - Emulador educativo de Game Boy Color</p>
            <p>Proyecto Open Source - Clean-Room Implementation</p>
            <p>No se copia c√≥digo de otros emuladores. Basado √∫nicamente en documentaci√≥n t√©cnica.</p>
        </footer>
    </div>
</body>
</html>

